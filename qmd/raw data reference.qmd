---
title: "Data Dictionary & Variable Construction Reference"
subtitle: "Repo A: PA UST Combined Datasets"
author:
  - name: "Analytical Engine"
    affiliation: "Project Team"
date: last-modified
date-format: "MMMM D, YYYY"
abstract: |
  This document serves as the definitive technical reference for the raw datasets in Repo A (Facility/Tank Master Database). It characterizes the distributions of key variables—including tank status, substance types, and component attributes—and identifies specific data quality issues such as default installation dates. The frequency tables presented herein are intended to guide the "hotcoding" of binary variables and the treatment of missing data for downstream econometric analysis.
format:
  pdf:
    toc: true
    toc-depth: 2
    number-sections: true
    fontsize: 11pt
    geometry:
      - top=1in
      - bottom=1in
      - left=1in
      - right=1in
    keep-tex: false
    link-citations: true
    colorlinks: true
    include-in-header:
      text: |
        \usepackage{xcolor}
        \usepackage{colortbl}
        \usepackage{float}
        \usepackage{graphicx}
        \usepackage{adjustbox}
        \usepackage{tabularx}
        \usepackage{array}
        \usepackage{tikz}
        \usetikzlibrary{shapes.geometric, arrows.meta, positioning, calc, shadows}
  html:
    toc: true
    toc-depth: 2
    number-sections: true
    theme: cosmo
    code-fold: true
---

```{r setup}
#| echo: false
#| warning: false
#| message: false
library(readr)
library(dplyr)
library(knitr)
library(stringr)

# --- CONFIGURATION ---
# Adjust this path if your QMD is in a different folder than 'output/tables'
table_dir <- "../output/tables" 
figure_dir <- "../output/figures"

# Helper function to find table file (handles truncated filenames)
find_table_file <- function(filename_base, extension = ".tex") {
  # First try exact match
  exact_path <- file.path(table_dir, paste0(filename_base, extension))
  if (file.exists(exact_path)) {
    return(exact_path)
  }
  # Try to find files that start with the base name (handles truncation with dots)
  # Escape special regex characters in filename_base
  pattern <- paste0("^", gsub("([.^$+?(){}[\\|])", "\\\\\\1", filename_base, perl = TRUE))
  # Look for files starting with pattern and ending with extension (may have dots in between)
  all_files <- list.files(table_dir, pattern = paste0(pattern, ".*", extension, "$"), full.names = TRUE)
  if (length(all_files) > 0) {
    return(all_files[1])  # Return first match
  }
  return(NULL)
}

include_table <- function(filename_base) {
  if (knitr::is_latex_output()) {
    tex_path <- find_table_file(filename_base, ".tex")
    if (!is.null(tex_path) && file.exists(tex_path)) {
      cat(readLines(tex_path), sep = "\n")
    } else {
      cat("\\textbf{Error: Table file not found:}", filename_base, "\n")
    }
  } 
  else if (knitr::is_html_output()) {
    html_path <- find_table_file(filename_base, ".html")
    if (!is.null(html_path) && file.exists(html_path)) {
      cat(readLines(html_path), sep = "\n")
    } else {
      cat("**Error: Table file not found:**", filename_base, "\n")
    }
  }
}

# Helper function to include figures
include_figure <- function(filename_base) {
  fig_path <- file.path(figure_dir, paste0(filename_base, ".png"))
  if (file.exists(fig_path)) {
    # Use knitr::include_graphics for proper Quarto integration
    # The chunk options will handle sizing via fig-width
    knitr::include_graphics(fig_path)
  } else {
    if (knitr::is_latex_output()) {
      cat("\\textbf{Error: Figure file not found:}", fig_path, "\n")
    } else {
      cat("**Error: Figure file not found:**", fig_path, "\n")
    }
  }
}
```

\newpage

# Facility & Tank Characteristics

This section details the primary grouping variables derived from the harmonized Active (PADEP) and Inactive (SSRS) datasets.

## Tank Status

[Description: Explanation of how Active vs. Inactive status is defined.]



```{r tank-status-table}
#| label: tbl-tank-status
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("001_tank_status_freq")
```

[Table Note: Verify if 'Temporarily Out of Use' tanks should be treated as active for auction eligibility.]

\newpage
## Substance Profile

[Description: Breakdown of fuel types stored in the tanks, mapped from raw substance codes to boolean flags.]



```{r substance-profile-table}
#| label: tbl-substance-profile
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("002_substance_counts")
```

[Table Note: These counts are based on the mapping of raw substance codes (e.g., "GAS", "DIESL") to consolidated categories.]

\newpage
## Installation Date Diagnostics

[Description: Assessment of data quality for DATE_INSTALLED.]



```{r date-diagnostics-table}
#| label: tbl-date-diagnostics
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("003_date_defaults")
```

[Table Note: The dates listed above are likely system defaults (e.g., 01/01/1900) and should be treated as missing values.]

\newpage

### KNN Date Imputation Diagnostics

[Description: Comparison of reported installation dates vs. KNN-imputed dates for records with suspect default values. KNN regression (k=5) uses capacity, substance type, and region as features.]

```{r knn-imputation-figure}
#| label: fig-knn-imputation
#| fig-cap: "KNN Date Imputation Diagnostics: Reported vs. Imputed Installation Years"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("003b_knn_imputation_diagnostics")
```

[Figure Note: Density comparison showing distributional plausibility of KNN-imputed dates relative to observed installation years. Imputed values should align with historical installation patterns.]

\newpage
# Component Universe

This section details the raw attributes available in the 'Compounds' table. These tables help map specific attributes to what the 'hotcoded' variables mean.
We will also use  these tables to determine and build the corseined human-derired characteristics variables.



## Tank Specifics

### Release Detection

```{r tank-release-detection-table}
#| label: tbl-tank-release-detection
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_tank_release_detection_method")
```


\newpage

Using @tbl-tank-release-detection the table below is how we  coarsen the relsease dection variables `release_detection_method`:


#### Release Detection - Coarsened mapping



\newpage

```{r tank-release-detection-table}
#| label: tbl-tank-release-detection-method
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

library(readr)
library(dplyr)
library(knitr)
library(stringr)
library(kableExtra)

# 1. Embed the ASCII data
# We include the table grid and the specific classification notes.
ascii_data <- "
Component Universe: TANK RELEASE DETECTION METHOD (CLASSIFIED)
+------+----------------------------------------+-------+-----------------------------+-----------------------+
| CODE | COMPONENT_TYPE                         |     N | METHOD CATEGORY             | REGULATION CITATION   |
+------+----------------------------------------+-------+-----------------------------+-----------------------+
| 12H  | INTERSTITIAL MONITORING (2 WALLS)      | 13753 | Secondary Containment (IM)  | 40 CFR § 280.43(g)    |
| 12I  | INTERSTITIAL MONITORING (LINER)        |     9 | Secondary Containment (IM)  | 40 CFR § 280.43(g)    |
| 12L  | GROOVES MADE IN THE IMPERMEABLE PAD    |     2 | Secondary Containment (IM)  | 40 CFR § 280.43(g)    |
| 12M  | SLOTTED PIPE ABOVE THE IMPERMEABLE PAD |     4 | Secondary Containment (IM)  | 40 CFR § 280.43(g)    |
|      |                                        |       |                             |                       |
| 12E  | AUTOMATIC TANK GAUGING                 | 17834 | Internal Monitoring (ATG)   | 40 CFR § 280.43(d)    |
| 12D  | STATISTICAL INVENTORY RECONCILIATION   |  4683 | Internal Monitoring (SIR)   | 40 CFR § 280.43(h)    |
| 12F  | MANUAL TANK GAUGING (36 HRS)           |   407 | Internal Monitoring (MTG)* | 40 CFR § 280.43(b)    |
| 12G  | MANUAL TANK GAUGING (44 OR 58 HRS)     |   383 | Internal Monitoring (MTG)* | 40 CFR § 280.43(b)    |
|      |                                        |       |                             |                       |
| 12A  | MONTHLY INVENTORY CONTROL              |  3611 | Inventory Control** | 40 CFR § 280.43(a)    |
| 12B  | ANNUAL TANK TIGHTNESS TESTING          |  2985 | Tightness Testing** | 40 CFR § 280.43(c)    |
| 12C  | TANK TIGHTNESS TESTING (EVERY 5 YEARS) |   535 | Tightness Testing** | 40 CFR § 280.43(c)    |
|      |                                        |       |                             |                       |
| 12J  | GROUNDWATER MONITORING                 |    79 | External Monitoring         | 40 CFR § 280.43(f)    |
| 12K  | VAPOR MONITORING                       |    58 | External Monitoring         | 40 CFR § 280.43(e)    |
|      |                                        |       |                             |                       |
| 1299 | OTHER                                  |     8 | Other/Unclassified          | 40 CFR § 280.40(a)    |
| 12N  | NONE                                   |  2833 | Non-Compliant/Missing       | Violation § 280.40(a) |
| 12O  | EXEMPT                                 |   953 | Exempt/Deferred             | 40 CFR § 280.10       |
+------+----------------------------------------+-------+-----------------------------+-----------------------+
"

# 2. Parse the Table
lines <- str_split(ascii_data, "\n")[[1]]
table_lines <- lines[str_detect(lines, "^\\|")]

df <- read_delim(
  I(table_lines), 
  delim = "|", 
  trim_ws = TRUE, 
  show_col_types = FALSE
) %>%
  select(-1, -last_col()) %>%
  filter(!is.na(CODE))

# 3. Define Footnotes
# These explain the asterisks (* and **) in the table body.
# We treat the text block about Citation Logic as external analysis, not part of the table footer.
note_1 <- "* MTG (12F/12G): Only valid for tanks <= 1,000 gallons (or up to 2,000 gallons under specific diameter conditions)."
note_2 <- "** Inventory Control/Tightness Testing (12A/12B): Must be combined with Tightness Testing (valid only for 10 years after install) or used temporarily."

# 4. Render
kable(df, booktabs = TRUE, caption = "Component Universe: TANK RELEASE DETECTION METHOD (CLASSIFIED)") %>%
  kableExtra::footnote(
    general = c(note_1, note_2),
    general_title = "Notes on Classifications: ",
    footnote_as_chunk = TRUE
  )
```


\newpage

```{r release-detection-compliance-mapping}
#| label: tbl-rd-compliance-mapping
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-cap: "Regulatory Validity Mapping: Tank Release Detection Methods by Cohort"

library(tibble)
library(dplyr)
library(knitr)

# Define the Mapping Dataframe
compliance_map <- tribble(
  ~Cohort, ~Compliance_Status, ~Method_Codes, ~Method_Description, ~Regulatory_Logic,
  
  # --- COHORT 1: 2016 Rule (Post-Oct 2015 Installs) ---
  "2016 Rule (New Installs)", "VALID", "12H, 12I, 12L, 12M", "Interstitial Monitoring (Secondary Containment)", "Mandatory for all new installs (40 CFR § 280.41(a)(1)(i)).",
  "2016 Rule (New Installs)", "INVALID", "12E, 12D, 12J, 12K", "Internal/External Monitoring (Single Wall)", "Prohibited for new installs; Secondary Containment required.",
  "2016 Rule (New Installs)", "INVALID", "12A + 12B/12C", "Inventory Control + Tightness Testing", "Prohibited for new installs.",
  
  # --- COHORT 2: 1998 Rule (Legacy/Existing Tanks) ---
  "1998 Rule (Legacy)", "VALID", "12H, 12I", "Interstitial Monitoring", "Valid indefinitely (Gold Standard).",
  "1998 Rule (Legacy)", "VALID", "12E", "Automatic Tank Gauging (ATG)", "Valid if capable of detecting 0.2 gph leak rate.",
  "1998 Rule (Legacy)", "VALID", "12D", "Statistical Inventory Reconciliation (SIR)", "Valid if quantitative results meet 0.2 gph threshold.",
  "1998 Rule (Legacy)", "CONDITIONAL", "12J, 12K", "Groundwater / Vapor Monitoring", "Valid only if site assessment confirms porous soil/water table suitability. Cannot be added to new sites.",
  "1998 Rule (Legacy)", "CONDITIONAL", "12F, 12G", "Manual Tank Gauging (MTG)", "Valid ONLY for tanks <= 1000 gal (or <= 2000 gal w/ precise dimensions).",
  "1998 Rule (Legacy)", "SUNSET/EXPIRED", "12A + 12B", "Inventory Control + Annual TTT", "Valid only for 10 years after installation. As of 2026, all eligible tanks have exceeded this window.",
  "1998 Rule (Legacy)", "INVALID", "12A (Solo)", "Inventory Control (Solo)", "Never valid as a standalone method (must pair with TTT or ATG)."
)

# Render
kable(compliance_map, booktabs = TRUE) %>%
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "top") %>%
    kable_styling(latex_options = c("scale_down", "hold_position"))

```


\newpage

### Tank Construction

```{r tank-construction-table}
#| label: tbl-tank-construction
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_tank_construction")
```

\newpage


#### Tank Construction - Coarsened mapping


Using @tbl-tank-construction the table below is how we  coarsen the construction variables `construction_type`:


```{r tank-release-detection-table}
#| label: tbl-tank-construction-mapped
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

library(readr)
library(dplyr)
library(knitr)
library(stringr)

# 1. Embed the ASCII table directly as a text block
ascii_data <- "
Component Universe: TANK CONSTRUCTION (CLASSIFIED)
+------+--------------------------------------------------------+------+------------------------+---------------------------------+
| CODE | COMPONENT_TYPE                                         |    N | Construction | REGULATION CITATION             |
+------+--------------------------------------------------------+------+------------------------+---------------------------------+
| 1D   | UNPROTECTED STEEL (DOUBLE WALL)                        |   75 | Secondary Containment  | 40 CFR § 280.43(g)              |
| 1F   | FIBERGLASS (DOUBLE WALL)                               | 8272 | Secondary Containment  | 40 CFR § 280.43(g)              |
| 1G   | STEEL W/PLASTIC OR FIBERGLASS JACKET (DOUBLE WALL)     | 5378 | Secondary Containment  | 40 CFR § 280.43(g)              |
| 1O   | CATHODICALLY PROTECTED DOUBLE WALL STEEL (GALVANIC)    | 3100 | Secondary Containment  | 40 CFR § 280.43(g)              |
| 1V   | STEEL W/PLASTIC OR FRP JACKET W/ ANODES (DOUBLE WALL)  |  445 | Secondary Containment  | 40 CFR § 280.43(g)              |
|      |                                                        |      |                        |                                 |
| 1A   | UNPROTECTED STEEL (SINGLE WALL)                        | 5368 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
| 1B   | CATHODICALLY PROTECTED STEEL (GALVANIC)                | 7094 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
| 1C   | CATHODICALLY PROTECTED STEEL (IMPRESSED CURRENT)       | 2284 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
| 1E   | FIBERGLASS (SINGLE WALL)                               | 8647 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
| 1H   | STEEL W/FRP COATING (ACT 100 OR EQUIV) (SINGLE WALL)   |  961 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
| 1I   | STEEL W/LINED INTERIOR                                 |  750 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
| 1J   | CONCRETE                                               |   31 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
| 1P   | CATHODICALLY PROTECTED STEEL WITH LINER                |  572 | Single Wall (Legacy)* | 40 CFR § 280.41(a)(1)           |
| 1W   | STEEL W/FRP COATING W/ ANODES (SINGLE WALL)            |   15 | Single Wall (Legacy)   | 40 CFR § 280.41(a)(1)           |
|      |                                                        |      |                        |                                 |
| 188  | OTHER (COMPLIANT)                                      |   15 | Unknown/Other          | 40 CFR § 280.40(a)              |
| 199  | OTHER                                                  |   69 | Unknown/Other          | 40 CFR § 280.40(a)              |
| 1K   | BOTTOM MODIFICATION                                    |    1 | Unknown/Other          | 40 CFR § 280.40(a)              |
| 1N   | UNKNOWN                                                |  194 | Unknown/Other          | 40 CFR § 280.40(a)              |
+------+--------------------------------------------------------+------+------------------------+---------------------------------+
Note: Codes 1I and 1P (Lined Interior) generally indicate internal lining repairs (280.21(b)(1)), not secondary containment bladders.
"

# 2. Process the text
# Split into lines
lines <- str_split(ascii_data, "\n")[[1]]

# Filter for rows that actually contain data (start with a pipe '|')
# This automatically drops the "+---+" separators and the "Note:" line
table_lines <- lines[str_detect(lines, "^\\|")]

# 3. Create DataFrame
df <- read_delim(
  I(table_lines), 
  delim = "|", 
  trim_ws = TRUE, 
  show_col_types = FALSE
) %>%
  # Remove artifact columns (first and last are empty due to outer pipes)
  select(-1, -last_col()) %>%
  # Remove the blank spacer rows (where CODE is empty/NA)
  filter(!is.na(CODE))

# 4. Render with Footer
# We extract the note explicitly since it was dropped during the filter step
footer_text <- "Codes 1I and 1P (Lined Interior) generally indicate internal lining repairs (280.21(b)(1)), not secondary containment bladders."

kable(df, booktabs = TRUE, caption = "Component Universe: TANK CONSTRUCTION (CLASSIFIED)") %>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%

  kableExtra::footnote(general = footer_text, general_title = "Note: ")

```


\newpage

## Piping Infrastructure

### Underground Piping Construction

```{r ug-piping-construction-table}
#| label: tbl-ug-piping-construction
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_ug_piping_construction")
```

[Table Note: Key variable for leak risk (e.g., Single Wall vs Double Wall, Galvanized vs Fiberglass).]

#### Piping - Coarsend Mapping

```{r piping-construction-compliance}
#| label: tbl-piping-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
#| tbl-cap: "Component Universe: Piping Construction & Regulatory Compliance (40 CFR § 280.42)"

library(readr)
library(dplyr)
library(knitr)
library(stringr)
library(kableExtra)

# 1. Unified ASCII Data
# Combines the counts (N), specific codes, and the regulatory logic into one view.
ascii_data <- "
+------------------------------------------+------+----------------------------------+-------+------------------------------------------+
| COARSENED_CATEGORY                       | CODE | COMPONENT_TYPE                   |     N | REGULATORY_STATUS                        |
+------------------------------------------+------+----------------------------------+-------+------------------------------------------+
| SECONDARY CONTAINMENT                    | 2I   | Double wall, metallic primary    |   490 | Valid for All Cohorts (Post-2016 & Legacy)|
| (Required for Post-2016 Installs)        | 2J   | Double wall, rigid (FRP) primary |  1623 | Valid for All Cohorts (Post-2016 & Legacy)|
|         | 2K   | Double wall, flexible primary    |  2756 | Valid for All Cohorts (Post-2016 & Legacy)|
|                                          | 2L   | TRENCH LINER                     |    16 | Valid (Functional Secondary Containment) |
|                                          | 2M   | JACKETED                         |    15 | Valid for All Cohorts (Post-2016 & Legacy)|
|                                          |      |                                  |       |                                          |
| SINGLE WALL                              | 2A   | BARE STEEL                       |  5870 | Legacy Only (High Risk - Req Cathodic)   |
| (Legacy Only - Pre-2016)                 | 2B   | CP METALLIC                      |  2137 | Legacy Only (Req 3-yr Cathodic Test)     |
|  | 2C   | COPPER                           |   213 | Legacy Only (Rare/Generator Use)         |
|                                          | 2D   | FIBERGLASS                       |  6331 | Legacy Only (Standard Pre-2016)          |
|                                          | 2E   | FLEXIBLE NON-METALLIC            |   488 | Legacy Only (Standard Pre-2016)          |
|                                          |      |                                  |       |                                          |
| OTHER / UNKNOWN                          | 288  | OTHER (COMPLIANT)                |    31 | Unclassified - Likely Specialized        |
|                                          | 299  | OTHER                            |    39 | Unclassified                             |
|                                          | 2F   | UNKNOWN                          |   218 | Data Gap                                 |
|                                          | 2G   | NONE                             |   793 | No Piping / Direct Fill / Gravity        |
|                                          | 2H   | MODIFICATION OF PIPING           |    15 | Maintenance Record (Not Construction)    |
+------------------------------------------+------+----------------------------------+-------+------------------------------------------+
"

# 2. Parse the Table
# We use the same 'stream' technique, filtering for pipe delimiters
lines <- str_split(ascii_data, "\n")[[1]]
table_lines <- lines[str_detect(lines, "^\\|")]

df <- read_delim(
  I(table_lines), 
  delim = "|", 
  trim_ws = TRUE, 
  show_col_types = FALSE
) %>%
  select(-1, -last_col()) %>%
  filter(!is.na(CODE)) %>%
  # Fill the 'COARSENED_CATEGORY' down so it doesn't just appear on the first row of the group
  tidyr::fill(COARSENED_CATEGORY, .direction = "down")

# 3. Define Footnotes for Context
# Extracted from your Regulatory Cohort and Suction Piping logic
notes <- c(
  "Post-2016 Rule: Installs after April 11, 2016 must use Secondary Containment with Interstitial Monitoring (IM).",
  "Safe Suction Exception: Single Wall piping (2A-2E) is exempt from release detection if sloped back to the tank with only one check valve.",
  "ALLD Requirement: Pressurized piping (Legacy or New) requires an Automatic Line Leak Detector."
)

# 4. Render
kable(df, booktabs = TRUE, longtable = FALSE)%>%
  # Group the first column to visually merge the categories
  collapse_rows(columns = 1, valign = "top") %>%
  # Add the regulatory footnotes
  footnote(number = notes, footnote_as_chunk = TRUE) %>%
  # styling for PDF fit
  kable_styling(latex_options = c("scale_down"))
```


\newpage

### Underground Piping: Single Inner Wall

```{r ug-single-inner-wall-table}
#| label: tbl-ug-single-inner-wall
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_ug_single_inner_wall_piping")
```

[Table Note: [Placeholder: Description of single inner wall piping characteristics.]]

#### Underground Piping: Single Inner Wall Coarsened

```{r inner-piping-material-compliance}
#| label: tbl-inner-piping-material
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
#| tbl-cap: "Component Universe: Primary Piping Material & Corrosion Susceptibility"

library(readr)
library(dplyr)
library(knitr)
library(stringr)
library(kableExtra)

# 1. Unified ASCII Data: Material + Corrosion Risk Mapping
ascii_data <- "
+------------------------------------------+-------+-----------------------+-------+------------------------------------------+
| COARSENED_CATEGORY                       | CODE  | COMPONENT_TYPE        |     N | REGULATORY_STATUS                        |
+------------------------------------------+-------+-----------------------+-------+------------------------------------------+
| NON-CORRODIBLE                           | 28E   | FLEX                  | 12507 | Modern Standard (Inherently Safe)        |
| (Modern Standard - No CP Needed)         | 28D   | FRP                   |  8859 | Modern Standard (Inherently Safe)        |
|                                          |       |                       |       |                                          |
| METALLIC / CORRODIBLE                    | 28A   | BARE STEEL            |   465 | High Risk (Requires CP or Isolation)     |
| (Legacy - Maintenance Required)          | 28B   | CP PROTECTED          |   712 | High Risk (Requires 3-Year CP Testing)   |
|                                          | 28C   | COPPER                |   167 | Legacy (Often generator/heating oil)     |
|                                          | 28I   | STAINLESS STEEL       |    47 | Low Risk (Corrosion Resistant Metal)* |
|                                          |       |                       |       |                                          |
| OTHER / EXEMPT                           | 28G   | NO DISPENSING PIPING  |   373 | Exempt (Suction/Gravity/Waste Oil)       |
|                                          | 2889  | OTHER                 |    34 | Unclassified                             |
|                                          | 28F   | UNKNOWN               |    10 | Data Gap                                 |
+------------------------------------------+-------+-----------------------+-------+------------------------------------------+
"

# 2. Parse the Table
lines <- str_split(ascii_data, "\n")[[1]]
table_lines <- lines[str_detect(lines, "^\\|")]

df <- read_delim(
  I(table_lines), 
  delim = "|", 
  trim_ws = TRUE, 
  show_col_types = FALSE
) %>%
  select(-1, -last_col()) %>%
  filter(!is.na(CODE)) %>%
  # Fill the Category column down for visual grouping
  tidyr::fill(COARSENED_CATEGORY, .direction = "down")

# 3. Define Footnotes
notes <- c(
  "Non-Corrodible: Fiberglass (FRP) and Flexible piping (Flex) do not rust and require no cathodic protection maintenance.",
  "Legacy/Metallic: Steel and Copper piping must be cathodically protected (impressed current or galvanic) and tested every 3 years (40 CFR 280.31).",
  "*Stainless Steel (28I): While metallic, stainless steel is often resistant enough to bypass CP requirements depending on soil conditions, but is rare in general retail use."
)

# 4. Render
kable(df, booktabs = TRUE, longtable = FALSE)%>%
  collapse_rows(columns = 1, valign = "top") %>%
  footnote(number = notes, footnote_as_chunk = TRUE) %>%
  kable_styling(latex_options = c("scale_down"))
```

  **Component Definition:** This variable describes the material composition of the **primary** product-carrying pipe (the inner wall), which determines the system's susceptibility to corrosion and whether Cathodic Protection (CP) maintenance is legally required.

\newpage

### Underground Piping: Outer Wall

```{r ug-outer-wall-table}
#| label: tbl-ug-outer-wall
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_ug_outer_wall_piping")
```

[Table Note: [Placeholder: Description of outer wall piping characteristics.]]

\newpage

```{r outer-piping-material-compliance-fixed}
#| label: tbl-outer-piping-fixed
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
#| tbl-cap: "Component Universe: Secondary Containment (Outer Wall) Material"

library(readr)
library(dplyr)
library(knitr)
library(stringr)
library(kableExtra)

# 1. Define Data with Explicit Mappings
ascii_data <- "
+------------------------------------------+-------+-------------------------------------+-------+----------------------------------------------+
| COARSENED_CATEGORY                       | CODE  | COMPONENT_TYPE                      |     N | REGULATORY_STATUS                            |
+------------------------------------------+-------+-------------------------------------+-------+----------------------------------------------+
| MODERN SECONDARY CONTAINMENT             | 29E   | FLEX, OUTER                         | 12227 | Standard Compliant (Non-Corrodible)          |
| MODERN SECONDARY CONTAINMENT             | 29D   | FRP, OUTER                          |  3985 | Standard Compliant (Non-Corrodible)          |
| MODERN SECONDARY CONTAINMENT             | 29I   | POLY-ENCASED STAINLESS STEEL, OUTER |    19 | Compliant (Specialized)                      |
| MODERN SECONDARY CONTAINMENT             | 2999  | OTHER, OUTER                        |   263 | Likely Compliant (Non-Standard Material)     |
|                                          |       |                                     |       |                                              |
| NO SECONDARY CONTAINMENT                 | 29N   | NONE                                |  6295 | Single Wall System (Legacy Only)             |
|                                          |       |                                     |       |                                              |
| METALLIC SECONDARY                       | 29A   | BARE STEEL, OUTER                   |   204 | High Risk (Outer Wall Requires CP)           |
| METALLIC SECONDARY                       | 29B   | CP PROTECTED, OUTER                 |    51 | High Risk (Requires 3-Year Testing)          |
|                                          |       |                                     |       |                                              |
| UNKNOWN / DATA GAP                       | 29F   | UNKNOWN, OUTER                      |    14 | Data Gap                                     |
+------------------------------------------+-------+-------------------------------------+-------+----------------------------------------------+
"

# 2. Process Data
lines <- str_split(ascii_data, "\n")[[1]]
table_lines <- lines[str_detect(lines, "^\\|")]

df <- read_delim(
  I(table_lines), 
  delim = "|", 
  trim_ws = TRUE, 
  show_col_types = FALSE
) %>%
  select(-1, -last_col()) %>%
  filter(!is.na(CODE))

# 3. Render with Explicit Widths + Adjustbox Scaling
kable(df, booktabs = TRUE, longtable = FALSE) %>% 
  # A. Define Column Widths to Force Text Wrapping (Prevents Overlap)
  column_spec(1, width = "3.5cm", bold = TRUE) %>%  # Category: Bold & wide enough to read
  column_spec(2, width = "1.5cm") %>%               # Code: Narrow
  column_spec(3, width = "4cm") %>%                 # Type: Wraps if long
  column_spec(4, width = "1cm") %>%                 # N: Narrow
  column_spec(5, width = "4cm") %>%                 # Status: Wraps long descriptions
  
  # B. Add Visual Separators
  row_spec(0, bold = TRUE) %>%                      # Bold Header
  
  # C. Scale Down to Fit Page
  kable_styling(latex_options = c("scale_down", "hold_position", "striped")) %>%
  
  # D. Add Footnotes
  footnote(
    number = c(
      "None (29N): Indicates Single Wall system (Legacy).",
      "Metallic Outer: Requires separate cathodic protection."
    ),
    footnote_as_chunk = TRUE
  )

```

**Component Definition:** This variable identifies the material of the secondary containment layer (the outer tube in a double-walled system) which serves to capture leaks from the primary pipe and create the interstitial space necessary for leak detection monitoring.


\newpage

### Aboveground Piping: Corrosion Protection

```{r ag-piping-corrosion-table}
#| label: tbl-ag-piping-corrosion
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_ag_piping_construction_corrosion_prot")
```

[Table Note: [Placeholder: Description of aboveground piping corrosion protection methods.]]

\newpage

### Piping Release Detection

```{r pipe-release-detection-table}
#| label: tbl-pipe-release-detection
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_pipe_release_detection_method")
```

[Table Note: [Placeholder: Description of piping release detection methods.]]

\newpage

### Line Leak Detectors

```{r line-leak-detector-table}
#| label: tbl-line-leak-detector
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_line_leak_detector_shuts_off_pump")
```

[Table Note: [Placeholder: Description of line leak detector functionality.]]

\newpage

### Secondary Containment

```{r secondary-containment-table}
#| label: tbl-secondary-containment
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_ust_total_secondarily_contained")
```

[Table Note: [Placeholder: Description of secondary containment systems.]]

# Regulatory & Compliance

\newpage

## Certificates & Permits

```{r registration-certificate-table}
#| label: tbl-registration-certificate
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_registration_certificate")
```

[Table Note: [Placeholder: Description of registration certificate requirements.]]

```{r fire-marshal-permit-table}
#| label: tbl-fire-marshal-permit
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_fire_marshal_permit")
```

[Table Note: [Placeholder: Description of fire marshal permit requirements.]]

\newpage

## Prevention Systems (Spill & Overfill)

```{r spill-prevention-table}
#| label: tbl-spill-prevention
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_spill_prevention")
```

[Table Note: [Placeholder: Description of spill prevention systems.]]

```{r overfill-prevention-table}
#| label: tbl-overfill-prevention
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_overfill_prevention")
```

[Table Note: Presence of these systems often correlates with lower premiums.]

\newpage

## Vapor Recovery Systems

```{r vapor-recovery-table}
#| label: tbl-vapor-recovery
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_vapor_recovery")
```

[Table Note: [Placeholder: Description of vapor recovery systems.]]

```{r stage-i-vapor-recovery-table}
#| label: tbl-stage-i-vapor-recovery
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_stage_i_vapor_recovery")
```

[Table Note: [Placeholder: Description of Stage I vapor recovery.]]

```{r stage-ii-vapor-recovery-table}
#| label: tbl-stage-ii-vapor-recovery
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_stage_ii_vapor_recovery")
```

[Table Note: Stage II recovery is largely phased out; check if this indicates older infrastructure.]

\newpage

## Containment & Sumps

```{r tank-top-containment-table}
#| label: tbl-tank-top-containment
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_tank_top_containment_sumps")
```

[Table Note: [Placeholder: Description of tank top containment sumps.]]

```{r under-dispenser-containment-table}
#| label: tbl-under-dispenser-containment
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_under_dispenser_containment")
```

[Table Note: 'UDC' (Under Dispenser Containment) is a critical modern safety feature.]

\newpage

# Miscellaneous Components

## Flexible Connectors

```{r piping-flexible-connectors-table}
#| label: tbl-piping-flexible-connectors
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_piping_flexible_connectors")
```

[Table Note: [Placeholder: Description of flexible connector types.]]

```{r flex-tank-end-table}
#| label: tbl-flex-tank-end
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_flex_tank_end")
```

[Table Note: [Placeholder: Description of flexible connectors at tank end.]]

```{r flex-dispenser-end-table}
#| label: tbl-flex-dispenser-end
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_flex_dispenser_end")
```

[Table Note: [Placeholder: Description of flexible connectors at dispenser end.]]

\newpage

## Other Hardware

```{r pump-delivery-system-table}
#| label: tbl-pump-delivery-system
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_pump_delivery_system")
```

[Table Note: [Placeholder: Description of pump delivery system types.]]

```{r emergency-generator-table}
#| label: tbl-emergency-generator
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_emergency_generator")
```

[Table Note: [Placeholder: Description of emergency generator installations.]]

\newpage

## Unclassified / Other

```{r na-components-table}
#| label: tbl-na-components
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_na")
```

[Table Note: [Placeholder: Description of unclassified or N/A component entries.]]

```{r tank-upgrade-table}
#| label: tbl-tank-upgrade
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("004_comp_tank_upgrade")
```

[Table Note: [Placeholder: Description of tank upgrade activities.]]

\newpage

# Owner & Business Intelligence

This section characterizes facility ownership structure, business model classification, and market segmentation derived from the harmonized facility linkage table.

## Business Model Distribution

[Description: Classification of facilities by business category based on owner sector and facility count logic.]

```{r business-model-table}
#| label: tbl-business-model
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("005_business_model_counts")
```

[Table Note: Business categories derived from owner name pattern matching and facility count thresholds. "Publicly Owned" includes government and municipal entities; "Retail Gas (Branded Commercial)" includes major chains.]

\newpage

## Owner Fleet Size Distribution

[Description: Distribution of facilities and tanks across owner size classes.]

```{r owner-size-table}
#| label: tbl-owner-size
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("006_owner_size_class_freq")
```

[Table Note: Owner size classification based on facility count per owner: Single-Site (1), Small Fleet (2-9), Medium Fleet (10-49), Large Fleet/Corporate (50+).]

\newpage

## Owner Sector Breakdown

[Description: Top 25 owner sectors by tank count, derived from owner name pattern classification.]

```{r owner-sector-table}
#| label: tbl-owner-sector
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("007_owner_sector_freq")
```

[Table Note: Sector classification uses regex pattern matching on owner names to identify major chains, government entities, utilities, and commercial sectors.]

\newpage

## Facility Operational Status

[Description: Aggregate facility-level operational status based on tank closure patterns.]

```{r facility-status-table}
#| label: tbl-facility-status
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("008_facility_status_freq")
```

[Table Note: "Fully Active" = all tanks in use; "Fully Closed" = all tanks closed; "Mixed Status" = some active/some closed.]

\newpage

## Owner Size vs Business Model Cross-Tabulation

[Description: Cross-tabulation of owner fleet size against business category to identify structural patterns.]

```{r owner-business-crosstab-table}
#| label: tbl-owner-business-crosstab
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("009_owner_size_vs_business_crosstab")
```

[Table Note: Cell values represent unique facility counts. Useful for identifying which business models are dominated by small vs. large operators.]

\newpage

## Closure Rates by Business Category

[Description: Tank closure rates stratified by business category to identify differential attrition patterns.]

```{r closure-rates-table}
#| label: tbl-closure-rates
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'
include_table("010_closure_rates_by_facility_type")
```

[Table Note: Higher closure rates may indicate market exit, consolidation, or infrastructure modernization patterns specific to certain business types.]

\newpage

# Temporal Evolution & Trends

This section presents visualizations of how tank characteristics, fuel types, and facility attributes have evolved over time. These temporal patterns inform understanding of regulatory compliance trends and infrastructure modernization.

## Capacity Distribution

[Description: Overall distribution of tank capacities across the fleet.]

```{r capacity-distribution-figure}
#| label: fig-capacity-distribution
#| fig-cap: "Distribution of Tank Capacities (Gallons)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("005_capacity_distribution")
```

[Figure Note: Modal peaks at standard capacities (e.g., 10,000, 12,000, 15,000 gallons) indicate industry standardization. Long right tail represents commercial/industrial facilities.]

\newpage

## Capacity Evolution by Decade

[Description: Distribution of tank capacities across installation decades, showing trends in tank sizing over time.]

```{r capacity-evolution-figure}
#| label: fig-capacity-evolution
#| fig-cap: "Evolution of Tank Capacity Distribution by Installation Decade"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("005b_capacity_evolution_by_decade")
```

[Figure Note: [Placeholder: Interpretation of capacity trends—have tanks gotten larger over time? Implications for replacement costs and risk assessment.]]



\newpage

## Fuel Mix Evolution

[Description: Temporal shift in the proportion of gasoline, diesel, and other fuel types in new tank installations.]

```{r fuel-mix-evolution-figure}
#| label: fig-fuel-mix-evolution
#| fig-cap: "Evolution of Fuel Type Mix in New Installations (5-Year Periods)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("006_fuel_mix_evolution")
```

[Figure Note: [Placeholder: Analysis of fuel mix shifts—decline in gasoline share? Growth in diesel? Implications for risk profiles and insurance premiums.]]



\newpage

## Tank Lifespan Distribution

[Description: Distribution of tank ages at closure, showing typical service life and identifying outliers.]

```{r tank-lifespan-figure}
#| label: fig-tank-lifespan
#| fig-cap: "Distribution of Tank Age at Closure"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("007_tank_lifespan_distribution")
```

[Figure Note: [Placeholder: Interpretation of lifespan patterns—median age, typical range, and implications for remaining useful life of active tanks.]]


\newpage

# Facility-Level Intelligence

This section examines facility-level aggregations, including size distributions, survival patterns, and relationships between facility age and complexity.



## Facility Size Evolution by Decade

[Description: Distribution of facility sizes (number of tanks per facility) across facility vintage decades.]

```{r facility-size-evolution-figure}
#| label: fig-facility-size-evolution
#| fig-cap: "Evolution of Facility Size Distribution by Vintage Decade"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("008_facility_size_evolution_by_decade")
```

[Figure Note: [Placeholder: Interpretation of facility size trends—are newer facilities larger or smaller? Implications for operational complexity and risk concentration.]]


\newpage

## Facility Status by Vintage

[Description: Proportion of facilities in different status categories (Fully Active, Fully Closed, Mixed Status) by vintage decade.]

```{r facility-status-vintage-figure}
#| label: fig-facility-status-vintage
#| fig-cap: "Facility Survival Status by Vintage Decade"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("009_facility_status_by_vintage")
```

[Figure Note: [Placeholder: Analysis of facility survival patterns—do older facilities show higher closure rates? Implications for portfolio risk assessment.]]



\newpage

## Facility Age vs. Size Relationship

[Description: Scatter plot examining the relationship between facility age and number of tanks, with smoothed trend line.]

```{r facility-age-size-figure}
#| label: fig-facility-age-size
#| fig-cap: "Relationship Between Facility Age and Size"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("010_facility_age_vs_size_scatter")
```

[Figure Note: [Placeholder: Interpretation of age-size relationship—do older facilities tend to be larger? Implications for modernization costs and operational risk.]]

\newpage

# Fleet Risk & Infrastructure Analytics

This section examines construction-based risk tiers and capacity standardization trends to characterize infrastructure modernization patterns.

## Fleet Risk Tier Transition

[Description: Temporal evolution of tank construction risk tiers based on wall construction (single vs. double) and material type.]

```{r fleet-risk-figure}
#| label: fig-fleet-risk
#| fig-cap: "Fleet Risk Tier Transition by Installation Period"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("011_fleet_risk_transition")
```

[Figure Note: Risk tiers derived from TANK CONSTRUCTION component: "High Risk" = bare/single-wall steel; "Medium Risk" = single-wall fiberglass; "Low Risk" = double-walled or jacketed tanks. Transition toward lower-risk construction reflects regulatory evolution (e.g., 1998 EPA deadline).]

\newpage

## Capacity Standardization Trends

[Description: Installation frequency of standard tank capacities over time, showing market convergence on common sizes.]

```{r capacity-standardization-figure}
#| label: fig-capacity-standardization
#| fig-cap: "Installation Trends for Standard Tank Capacities (1980+)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("013_capacity_standardization_trends")
```

[Figure Note: Standard capacities (4000, 6000, 8000, 10000, 12000, 15000, 20000 gallons) shown. Trends indicate market preferences and potential cost efficiencies from standardization.]

\newpage

# Owner & Market Structure Analytics

This section presents visualizations of ownership patterns, market concentration, and temporal evolution of business categories.

## Owner Size Distribution

[Description: Distribution of tank counts across owner size classes.]

```{r owner-size-distribution-figure}
#| label: fig-owner-size-distribution
#| fig-cap: "Tank Count Distribution by Owner Size Class"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("014_owner_size_distribution")
```

[Figure Note: Horizontal bar chart showing relative market share by owner fleet size. Single-site operators vs. corporate fleet concentration.]

\newpage

## Mom & Pop Sector Breakdown

[Description: Sector distribution within single-site ("Mom & Pop") owners, showing business type diversity.]

```{r mom-pop-sector-figure}
#| label: fig-mom-pop-sector
#| fig-cap: "Top 10 Sectors Among Single-Site Owners"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("015_mom_pop_sector_breakdown")
```

[Figure Note: Identifies which business sectors dominate the single-site owner segment—critical for understanding small operator vulnerability to remediation costs.]

\newpage

## Major Chains Market Share

[Description: Tank counts for major retail chains operating in Pennsylvania.]

```{r major-chains-figure}
#| label: fig-major-chains
#| fig-cap: "Major Chains Market Share by Tank Count"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("016_major_chains_market_share")
```

[Figure Note: Identifies dominant retail fuel chains (Sheetz, Wawa, GetGo, etc.) and their relative infrastructure footprints in Pennsylvania.]

\newpage

## Owner Size Evolution

[Description: Temporal evolution of installation share by owner size class.]

```{r owner-size-evolution-figure}
#| label: fig-owner-size-evolution
#| fig-cap: "Evolution of Tank Installations by Owner Size Class (5-Year Periods)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("017_owner_size_evolution")
```

[Figure Note: Stacked area showing market consolidation trends—increasing corporate share vs. declining single-site operator share over time.]

\newpage

## Business Category Evolution

[Description: Temporal evolution of installation share by business category classification.]

```{r business-category-evolution-figure}
#| label: fig-business-category-evolution
#| fig-cap: "Evolution of Tank Installations by Business Category (5-Year Periods)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("018_business_category_evolution")
```

[Figure Note: Shows structural shifts in who is installing tanks—retail gas, fleet operations, public sector, etc. Useful for understanding changing composition of USTIF portfolio.]

\newpage

# Closure Dynamics

This section examines tank closure patterns over time, stratified by facility type.

## Tank Closures by Facility Type Timeline

[Description: Annual tank closures by business category, showing differential exit/modernization patterns.]

```{r closures-by-type-figure}
#| label: fig-closures-by-type
#| fig-cap: "Tank Closures by Facility Type (1985-2025)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false
include_figure("019_tank_closures_by_facility_type_timeline")
```

[Figure Note: Stacked area chart showing closure volume by business category over time. Peaks may correspond to regulatory deadlines (e.g., 1998 EPA compliance), market consolidation waves, or economic shocks. Useful for understanding historical claim volume drivers.]



\newpage

# USTIF Claims & Contracts Analysis

This section provides a summary of the USTIF claims and remediation contracts, adjusted for inflation to **2024 Real Dollars**.

## Claims Overview

[Description: Operational status and financial severity of claims, adjusted for inflation.]
```{r claims-status-table}
#| label: tbl-claims-status
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("101_claims_status_summary")
```

[Table Note: Claims categorized by operational status with real dollar costs adjusted to 2024 base year.]

\newpage

## Financial Severity

[Description: Distribution of real claim costs (log scale) showing the prevalence of high-severity events.]
```{r claims-severity-figure}
#| label: fig-claims-severity
#| fig-cap: "Distribution of Real Claim Severities (2024 Dollars)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 4.5
#| echo: false

include_figure("105_claims_cost_distribution_real")
```

[Figure Note: Log-scale distribution reveals long right tail characteristic of environmental remediation costs.]

\newpage

## Contracts & Auctions

[Description: Analysis of remediation contracts, comparing Bid-to-Result mechanisms against traditional models.]
```{r contract-types-table}
#| label: tbl-contract-types
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("106_contract_auction_types")
```

[Table Note: Contract mechanism breakdown showing PFP auction vs. T&M allocation patterns.]

\newpage
```{r contract-values-figure}
#| label: fig-contract-values
#| fig-cap: "Contract Value Distribution by Mechanism (Real 2024 Dollars)"
#| out-width: "100%"
#| fig-width: 7
#| fig-height: 5
#| echo: false

include_figure("108_contract_value_real_boxplot")
```

[Figure Note: Boxplot comparison of contract values by mechanism type. Caution: raw comparisons subject to selection bias per "naive fallacy" identified in research design.]

\newpage

# Appendix: Variable Inventory

[Description: Complete frequency dictionary for categorical variables in the Claims and Contracts datasets.]

## Claims Variables

### Claim Status
```{r var-claim-status-table}
#| label: tbl-var-claim-status
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("110_var_claim_status")
```

[Table Note: Distribution of claim operational status (open/closed).]

\newpage

### DEP Region
```{r var-dep-region-table}
#| label: tbl-var-dep-region
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("110_var_dep_region")
```

[Table Note: Geographic distribution of claims across PA DEP regional offices.]

\newpage

### County
```{r var-county-table}
#| label: tbl-var-county
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("110_var_county")
```

[Table Note: County-level claim frequency distribution.]

\newpage

### Location Description
```{r var-location-desc-table}
#| label: tbl-var-location-desc
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("110_var_location_desc")
```

[Table Note: Facility location type classification.]

\newpage

### Products
```{r var-products-table}
#| label: tbl-var-products
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("110_var_products")
```

[Table Note: Substance/product types associated with claims.]

\newpage

### Is Closed
```{r var-is-closed-table}
#| label: tbl-var-is-closed
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("110_var_is_closed")
```

[Table Note: Binary indicator for claim closure status.]

\newpage

### Is Open
```{r var-is-open-table}
#| label: tbl-var-is-open
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("110_var_is_open")
```

[Table Note: Binary indicator for claim open status.]

\newpage

## Contracts Variables

### Adjuster
```{r var-adjuster-table}
#| label: tbl-var-adjuster
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_adjuster")
```

[Table Note: ICF Claims Evaluator assignment distribution. Key variable for instrumental variable identification strategy.]

\newpage

### Consultant
```{r var-consultant-table}
#| label: tbl-var-consultant
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_consultant")
```

[Table Note: Environmental consulting firm assignment frequency.]

\newpage

### Brings to Closure
```{r var-brings-to-closure-table}
#| label: tbl-var-brings-to-closure
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_brings_to_closure")
```

[Table Note: Contract scope classification regarding site closure responsibility.]

\newpage

### Contract Category
```{r var-contract-category-table}
#| label: tbl-var-contract-category
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_contract_category")
```

[Table Note: High-level contract type categorization.]

\newpage

### Bid Type
```{r var-bid-type-table}
#| label: tbl-var-bid-type
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_bid_type")
```

[Table Note: Procurement mechanism classification (competitive bid vs. negotiated).]

\newpage

### Contract Type Raw
```{r var-contract-type-raw-table}
#| label: tbl-var-contract-type-raw
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_contract_type_raw")
```

[Table Note: Original contract type codes from source data.]

\newpage

### Auction Type
```{r var-auction-type-table}
#| label: tbl-var-auction-type
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_auction_type")
```

[Table Note: Auction mechanism subtype for PFP contracts.]

\newpage

### Is Bid to Result
```{r var-is-bid-to-result-table}
#| label: tbl-var-is-bid-to-result
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_is_bid_to_result")
```

[Table Note: Binary indicator for Performance-Fixed-Price (PFP) auction contracts. Primary treatment variable for causal analysis.]

\newpage

### Is Scope of Work
```{r var-is-scope-of-work-table}
#| label: tbl-var-is-scope-of-work
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_is_scope_of_work")
```

[Table Note: Binary indicator for traditional Time-and-Materials (T&M) contracts.]

\newpage

### Brings to Closure Flag
```{r var-brings-to-closure-flag-table}
#| label: tbl-var-brings-to-closure-flag
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| tbl-pos: 'H'

include_table("111_var_brings_to_closure_flag")
```

[Table Note: Binary indicator for contracts responsible for achieving site closure.]




```{tikz}
#| label: fig-ustif-process
#| fig-cap: "USTIF Claims Assignment and Auction Mechanism"
#| fig-align: center
#| echo: false

\usetikzlibrary{shapes.geometric, arrows.meta, positioning, calc, shadows}

% Define block styles
\tikzstyle{start} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=red!30, drop shadow]
\tikzstyle{process} = [rectangle, minimum width=3.5cm, minimum height=1cm, text centered, text width=3cm, draw=black, fill=blue!10, drop shadow]
\tikzstyle{auction} = [rectangle, minimum width=3.5cm, minimum height=1cm, text centered, text width=3.5cm, draw=black, fill=green!15, drop shadow]
\tikzstyle{decision} = [diamond, minimum width=3cm, minimum height=1cm, text centered, text width=2cm, draw=black, fill=yellow!20, drop shadow]
\tikzstyle{callout} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm, text centered, text width=4cm, draw=gray, fill=white, dashed, font=\footnotesize\itshape]
\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{line} = [thick,-]

\begin{tikzpicture}[node distance=2cm]

% --- Phase 1: Intake & Assignment ---
\node (start) [start] {Claim Initiated / Confirmed Release};

\node (adjuster) [decision, below of=start, yshift=-0.5cm] {ICF Claims Evaluator Review};
\node (callout_adjuster) [callout, right=1cm of adjuster] {``The Judge'' \\ Application of Bulletin \#5: \\ Is site ``stalled''? Complex? \\ (Tacit Rule of Assignment)};
\draw [dashed, gray] (adjuster) -- (callout_adjuster);

% --- Path A: Normal Claim (T&M) ---
\node (tm_neg) [process, left=2.5cm of adjuster, yshift=-2cm] {Time \& Materials (T\&M) Negotiation};
\node (tm_work) [process, below of=tm_neg] {Remedial Work \\ (Pay-as-you-go)};
\node (tm_end) [start, below of=tm_work] {Case Closure};

% --- Path B: Auction Process (Treatment) ---
\node (rfb) [auction, right=2.5cm of adjuster, yshift=-2cm] {RFB Development};
\node (callout_rfb) [callout, right=0.5cm of rfb] {Defined Scope vs. Bid-to-Result \\ (Creation of Base vs. Optional Milestones)};
\draw [dashed, gray] (rfb) -- (callout_rfb);

\node (site_visit) [auction, below of=rfb] {Mandatory Pre-Bid \\ Site Meeting};

\node (bids_in) [auction, below of=site_visit] {Bid Submission};

\node (admin_review) [decision, below of=bids_in, yshift=-0.5cm] {Admin Review};
\node (reject) [process, right=2cm of admin_review, fill=red!10] {Bid Rejected \\ (Non-responsive)};

\node (tech_score) [auction, below of=admin_review, yshift=-0.5cm] {Technical Scoring};
\node (callout_tech) [callout, right=0.5cm of tech_score] {Threshold Rule: \\ Must score $\ge$ 70-75\% of \\ highest tech score to advance};
\draw [dashed, gray] (tech_score) -- (callout_tech);

\node (cost_score) [auction, below of=tech_score, yshift=-0.5cm] {Cost Scoring};
\node (callout_cost) [callout, right=0.5cm of cost_score] {Formula: \\ $(1 - \frac{Bid - Low}{Low}) \times Points$ \\ Penalty if Bid $>$ 2x Low};
\draw [dashed, gray] (cost_score) -- (callout_cost);

\node (soft_cap) [decision, below of=cost_score, yshift=-1cm] {Determine ``Reasonable \& Necessary'' Cap};
\node (callout_cap) [callout, left=0.5cm of soft_cap] {The ``Soft Cap'': \\ USTIF sets max payout at \\ highest \textit{acceptable} bid, \\ not necessarily lowest bid.};
\draw [dashed, gray] (soft_cap) -- (callout_cap);

\node (selection) [auction, below of=soft_cap, yshift=-1cm] {Claimant Selection};
\node (callout_select) [callout, right=0.5cm of selection] {Principal-Agent Problem: \\ Claimant chooses winner \\ from ``Acceptable'' pool. \\ USTIF pays up to Cap.};
\draw [dashed, gray] (selection) -- (callout_select);

\node (contract) [start, below of=selection] {Fixed Price Contract Executed};

% --- Arrows ---
\draw [arrow] (start) -- (adjuster);

% Path A Arrows
\draw [arrow] (adjuster) -| node[anchor=south] {Routine / Low Complexity} (tm_neg);
\draw [arrow] (tm_neg) -- (tm_work);
\draw [arrow] (tm_work) -- (tm_end);

% Path B Arrows
\draw [arrow] (adjuster) -| node[anchor=south] {High Complexity / Stalled} (rfb);
\draw [arrow] (rfb) -- (site_visit);
\draw [arrow] (site_visit) -- (bids_in);
\draw [arrow] (bids_in) -- (admin_review);
\draw [arrow] (admin_review) -- node[anchor=west] {Pass} (tech_score);
\draw [arrow] (admin_review) -- node[anchor=south] {Fail} (reject);
\draw [arrow] (tech_score) -- (cost_score);
\draw [arrow] (cost_score) -- (soft_cap);
\draw [arrow] (soft_cap) -- (selection);
\draw [arrow] (selection) -- (contract);

\end{tikzpicture}
``` 



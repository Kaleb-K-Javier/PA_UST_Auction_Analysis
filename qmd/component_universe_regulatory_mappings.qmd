---
title: "Component Universe: Coarsened Regulatory Compliance Mappings"
subtitle: "Federal (40 CFR Part 280) and Pennsylvania (25 Pa. Code Ch. 245) Classifications"
date: last-modified
format:
  pdf:
    toc: true
    toc-depth: 3
    number-sections: true
    fontsize: 10pt
    geometry:
      - top=0.75in
      - bottom=0.75in
      - left=0.5in
      - right=0.5in
    keep-tex: false
    include-in-header:
      text: |
        \usepackage{xcolor}
        \usepackage{colortbl}
        \usepackage{float}
        \usepackage{graphicx}
        \usepackage{adjustbox}
        \usepackage{tabularx}
        \usepackage{array}
        \usepackage{longtable}
        \usepackage{booktabs}
        \usepackage{makecell}
        \usepackage{pdflscape}
        \renewcommand{\arraystretch}{1.2}
---

```{r setup}
#| echo: false
#| warning: false
#| message: false

library(knitr)
library(kableExtra)
library(dplyr)
library(tibble)

# Helper function for consistent table styling
render_compliance_table <- function(df, caption, footnotes = NULL) {
  tbl <- kable(df, 
               booktabs = TRUE, 
               caption = caption,
               escape = FALSE,
               longtable = TRUE) %>%
    kable_styling(
      latex_options = c("repeat_header", "scale_down", "hold_position"),
      font_size = 8,
      full_width = TRUE
    ) %>%
    column_spec(1, width = "0.6cm") %>%
    column_spec(2, width = "3.5cm") %>%
    column_spec(3, width = "0.8cm") %>%
    column_spec(4, width = "2.2cm") %>%
    column_spec(5, width = "2.0cm") %>%
    column_spec(6, width = "2.2cm") %>%
    column_spec(7, width = "2.0cm") %>%
    column_spec(8, width = "2.2cm")
  
  if (!is.null(footnotes)) {
    tbl <- tbl %>%
      footnote(
        general = footnotes,
        general_title = "Regulatory Notes: ",
        footnote_as_chunk = TRUE,
        threeparttable = TRUE
      )
  }
  
  return(tbl)
}


# --- CONFIGURATION ---
# Adjust this path if your QMD is in a different folder than 'output/tables'
table_dir <- "../output/tables" 
figure_dir <- "../output/figures"

# Helper function to find table file (handles truncated filenames)
find_table_file <- function(filename_base, extension = ".tex") {
  # First try exact match
  exact_path <- file.path(table_dir, paste0(filename_base, extension))
  if (file.exists(exact_path)) {
    return(exact_path)
  }
  # Try to find files that start with the base name (handles truncation with dots)
  # Escape special regex characters in filename_base
  pattern <- paste0("^", gsub("([.^$+?(){}[\\|])", "\\\\\\1", filename_base, perl = TRUE))
  # Look for files starting with pattern and ending with extension (may have dots in between)
  all_files <- list.files(table_dir, pattern = paste0(pattern, ".*", extension, "$"), full.names = TRUE)
  if (length(all_files) > 0) {
    return(all_files[1])  # Return first match
  }
  return(NULL)
}

include_table <- function(filename_base) {
  if (knitr::is_latex_output()) {
    tex_path <- find_table_file(filename_base, ".tex")
    if (!is.null(tex_path) && file.exists(tex_path)) {
      cat(readLines(tex_path), sep = "\n")
    } else {
      cat("\\textbf{Error: Table file not found:}", filename_base, "\n")
    }
  } 
  else if (knitr::is_html_output()) {
    html_path <- find_table_file(filename_base, ".html")
    if (!is.null(html_path) && file.exists(html_path)) {
      cat(readLines(html_path), sep = "\n")
    } else {
      cat("**Error: Table file not found:**", filename_base, "\n")
    }
  }
}

# Helper function to include figures
include_figure <- function(filename_base) {
  fig_path <- file.path(figure_dir, paste0(filename_base, ".png"))
  if (file.exists(fig_path)) {
    # Use knitr::include_graphics for proper Quarto integration
    # The chunk options will handle sizing via fig-width
    knitr::include_graphics(fig_path)
  } else {
    if (knitr::is_latex_output()) {
      cat("\\textbf{Error: Figure file not found:}", fig_path, "\n")
    } else {
      cat("**Error: Figure file not found:**", fig_path, "\n")
    }
  }
}

```



\newpage

# Tank Infrastructure

## Tank Construction

### Raw Frequency Table

```{r tank-construction-raw}
#| label: tbl-tank-construction-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_tank_construction")
```

\newpage

### Coarsened Regulatory Mapping: Tank Construction

```{r tank-construction-mapping}
#| label: tbl-tank-construction-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

tank_construction <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # DOUBLE WALL / SECONDARY CONTAINMENT
  "1D", "UNPROTECTED STEEL (DOUBLE WALL)", 75, "Secondary Containment", "Compliant (All Vintages)", "§280.20(a); §280.43(g)", "Compliant", "§245.421(a)",
  "1F", "FIBERGLASS (DOUBLE WALL)", 8272, "Secondary Containment", "Compliant (All Vintages)", "§280.20(a)(1); UL 1316", "Compliant", "§245.421(a)",
  "1G", "STEEL W/PLASTIC OR FRP JACKET (DW)", 5378, "Secondary Containment", "Compliant (All Vintages)", "§280.20(a)(3); UL 1746", "Compliant", "§245.421(a)",
  "1O", "CP DOUBLE WALL STEEL (GALVANIC)", 3100, "Secondary Containment", "Compliant (All Vintages)", "§280.20(a)(2); STI F841", "Compliant", "§245.421(a)",
  "1V", "STEEL W/FRP JACKET W/ANODES (DW)", 445, "Secondary Containment", "Compliant (All Vintages)", "§280.20(a)(2)-(3)", "Compliant", "§245.421(a)",
  
 # SINGLE WALL - LEGACY (Pre-April 11, 2016)
  "1A", "UNPROTECTED STEEL (SINGLE WALL)", 5368, "Single Wall (Legacy)", "Legacy: Compliant", "§280.21; §280.41(a)(1)", "Legacy: Compliant", "§245.421(b)",
  "1A", "UNPROTECTED STEEL (SINGLE WALL)", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  "1B", "CP STEEL (GALVANIC)", 7094, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(a)(2); §280.31", "Legacy: Compliant", "§245.421(b); §245.432",
  "1B", "CP STEEL (GALVANIC)", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  "1C", "CP STEEL (IMPRESSED CURRENT)", 2284, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(a)(2); §280.31(c)", "Legacy: Compliant", "§245.421(b); §245.432",
  "1C", "CP STEEL (IMPRESSED CURRENT)", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  "1E", "FIBERGLASS (SINGLE WALL)", 8647, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(a)(1); §280.41(a)(1)", "Legacy: Compliant", "§245.421(b)",
  "1E", "FIBERGLASS (SINGLE WALL)", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  "1H", "STEEL W/FRP COATING (ACT-100) (SW)", 961, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(a)(3); STI ACT-100®", "Legacy: Compliant", "§245.421(b)",
  "1H", "STEEL W/FRP COATING (ACT-100) (SW)", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  "1I", "STEEL W/LINED INTERIOR", 750, "Single Wall (Upgraded)", "Legacy: Conditional", "§280.21(b)(1); API 1631", "Legacy: Conditional", "§245.421(b)",
  "1I", "STEEL W/LINED INTERIOR", NA, "Single Wall (Upgraded)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  "1J", "CONCRETE", 31, "Single Wall (Legacy)", "Legacy: Conditional", "§280.20(a)(5)", "Legacy: Conditional", "§245.421(b)",
  "1P", "CP STEEL WITH LINER", 572, "Single Wall (Upgraded)", "Legacy: Compliant", "§280.21(b)(3)", "Legacy: Compliant", "§245.421(b)",
  "1P", "CP STEEL WITH LINER", NA, "Single Wall (Upgraded)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  "1W", "STEEL W/FRP COATING W/ANODES (SW)", 15, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(a)(2)-(3)", "Legacy: Compliant", "§245.421(b)",
  "1W", "STEEL W/FRP COATING W/ANODES (SW)", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)",
  
  # OTHER / UNKNOWN
  "188", "OTHER (COMPLIANT)", 15, "Other/Unknown", "Case-by-Case", "§280.20(a)(5)", "Case-by-Case", "§245.421",
  "199", "OTHER", 69, "Other/Unknown", "Presumed Non-Compliant", "§280.20(a)", "Presumed Non-Compliant", "§245.421",
  "1K", "BOTTOM MODIFICATION", 1, "Other/Unknown", "Repair Record Only", "§280.33", "Repair Record Only", "§245.433",
  "1N", "UNKNOWN", 194, "Data Gap", "UNKNOWN - Verify", "N/A", "UNKNOWN - Verify", "N/A"
)

footnotes_tank <- c(
  "Secondary Containment required for all tanks installed/replaced after April 11, 2016 (Federal) or December 22, 2018 (PA).",
  "Single-wall Legacy tanks must use monthly release detection per §280.41(a)(1); §280.43(d)-(i).",
  "Lined tanks (1I, 1P) require internal inspection within 10 years of lining and every 5 years thereafter per §280.21(b)(1)(ii).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/part-280; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/subchapEtoc.html"
)

render_compliance_table(tank_construction, 
                        "Tank Construction: Coarsened Regulatory Compliance Mapping",
                        footnotes_tank)
```

\newpage

## Tank Release Detection Method

### Raw Frequency Table

```{r tank-rd-raw}
#| label: tbl-tank-rd-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_tank_release_detection_method")
```

\newpage

### Coarsened Regulatory Mapping: Tank Release Detection

```{r tank-release-detection-mapping}
#| label: tbl-tank-rd-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

tank_rd <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # INTERSTITIAL MONITORING (GOLD STANDARD)
  "12H", "INTERSTITIAL MONITORING (2 WALLS)", 13753, "Secondary Containment (IM)", "Compliant (All Vintages)", "§280.43(g)", "Compliant", "§245.444(1)",
  "12H", "INTERSTITIAL MONITORING (2 WALLS)", NA, "Secondary Containment (IM)", "REQUIRED: Post-4/11/16 Tanks", "§280.41(a)(2)", "REQUIRED: Post-12/22/18", "§245.444(1)",
  "12I", "INTERSTITIAL MONITORING (LINER)", 9, "Secondary Containment (IM)", "Compliant (All Vintages)", "§280.43(g)", "Compliant", "§245.444(1)",
  "12L", "GROOVES IN IMPERMEABLE PAD", 2, "Secondary Containment (IM)", "Compliant (All Vintages)", "§280.43(g)", "Compliant", "§245.444(1)",
  "12M", "SLOTTED PIPE ABOVE PAD", 4, "Secondary Containment (IM)", "Compliant (All Vintages)", "§280.43(g)", "Compliant", "§245.444(1)",
  
  # INTERNAL MONITORING - LEGACY TANKS ONLY
  "12E", "AUTOMATIC TANK GAUGING", 17834, "Internal Monitoring (ATG)", "Legacy: Compliant", "§280.43(d); 0.2 gph", "Legacy: Compliant", "§245.444(2)",
  "12E", "AUTOMATIC TANK GAUGING", NA, "Internal Monitoring (ATG)", "Post-4/11/16: NON-COMPLIANT", "§280.41(a)(2) req IM", "Post-12/22/18: NON-COMPLIANT", "§245.444(1) req IM",
  "12D", "STATISTICAL INVENTORY RECONCILIATION", 4683, "Internal Monitoring (SIR)", "Legacy: Compliant", "§280.43(h); 0.2 gph", "Legacy: Compliant", "§245.444(6)",
  "12D", "STATISTICAL INVENTORY RECONCILIATION", NA, "Internal Monitoring (SIR)", "Post-4/11/16: NON-COMPLIANT", "§280.41(a)(2) req IM", "Post-12/22/18: NON-COMPLIANT", "§245.444(1) req IM",
  
  # MANUAL TANK GAUGING - CAPACITY RESTRICTED
  "12F", "MANUAL TANK GAUGING (36 HRS)", 407, "Internal Monitoring (MTG)", "Conditional: ≤550 gal only", "§280.43(b) Table", "Conditional: ≤550 gal", "§245.444(3)",
  "12F", "MANUAL TANK GAUGING (36 HRS)", NA, "Internal Monitoring (MTG)", "Post-4/11/16: NON-COMPLIANT", "§280.41(a)(2) req IM", "Post-12/22/18: NON-COMPLIANT", "§245.444(1) req IM",
  "12G", "MANUAL TANK GAUGING (44/58 HRS)", 383, "Internal Monitoring (MTG)", "Conditional: 551-1000 gal", "§280.43(b) Table", "Conditional: 551-1000 gal", "§245.444(3)",
  "12G", "MANUAL TANK GAUGING (44/58 HRS)", NA, "Internal Monitoring (MTG)", "Post-4/11/16: NON-COMPLIANT", "§280.41(a)(2) req IM", "Post-12/22/18: NON-COMPLIANT", "§245.444(1) req IM",
  
  # SUNSET / EXPIRED METHODS
  "12A", "MONTHLY INVENTORY CONTROL", 3611, "Inventory Control", "SUNSET: Must pair w/ TTT", "§280.43(a); §280.41(a)(1)(i)", "SUNSET", "§245.444(5)",
  "12A", "MONTHLY INVENTORY CONTROL", NA, "Inventory Control", "10-yr window expired (all)", "§280.41(a)(1)(i)", "10-yr window expired", "§245.444(5)",
  "12B", "ANNUAL TANK TIGHTNESS TEST", 2985, "Tightness Testing", "SUNSET: Supplemental only", "§280.43(c); 0.1 gph", "SUNSET: Supplemental", "§245.444(4)",
  "12B", "ANNUAL TANK TIGHTNESS TEST", NA, "Tightness Testing", "10-yr window expired (all)", "§280.41(a)(1)(i)", "10-yr window expired", "§245.444(4)",
  "12C", "TANK TIGHTNESS TEST (5 YRS)", 535, "Tightness Testing", "SUNSET: Supplemental only", "§280.43(c)", "SUNSET: Supplemental", "§245.444(4)",
  
  # EXTERNAL MONITORING - SITE-SPECIFIC
  "12J", "GROUNDWATER MONITORING", 79, "External Monitoring", "Conditional: Site Assessment", "§280.43(f); GW ≤20 ft", "Conditional: Site Assessment", "§245.444(8)",
  "12K", "VAPOR MONITORING", 58, "External Monitoring", "Conditional: Site Assessment", "§280.43(e); Porous backfill", "Conditional: Site Assessment", "§245.444(7)",
  
  # NON-COMPLIANT / OTHER
  "1299", "OTHER", 8, "Other/Unclassified", "Case-by-Case", "§280.40(a)", "Case-by-Case", "§245.444",
  "12N", "NONE", 2833, "NON-COMPLIANT", "VIOLATION", "§280.40(a) requires RD", "VIOLATION", "§245.441 requires RD",
  "12O", "EXEMPT", 953, "Exempt/Deferred", "Verify Exemption Basis", "§280.10(b)-(c)", "Verify Exemption Basis", "§245.1(b)"
)

footnotes_rd <- c(
  "Interstitial Monitoring (IM) REQUIRED for tanks installed/replaced after April 11, 2016 per §280.41(a)(2).",
  "ATG must detect 0.2 gph leak rate with Pd=0.95, Pfa=0.05 per §280.40(a)(4).",
  "MTG (12F/12G) valid ONLY for tanks ≤1,000 gal (or ≤2,000 gal with specific diameter) per §280.43(b).",
  "Inventory Control + TTT (12A+12B/12C): Valid only 10 years post-install; as of 2026, all eligible tanks have exceeded this window.",
  "Annual testing of ATG components required per §280.40(a)(3); PA requires annual testing per §245.437(a)(3).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/part-280/subpart-D; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.444.html"
)

render_compliance_table(tank_rd, 
                        "Tank Release Detection Method: Coarsened Regulatory Compliance Mapping",
                        footnotes_rd)
```

\newpage

# Piping Infrastructure

## Underground Piping Construction

### Raw Frequency Table

```{r ug-piping-raw}
#| label: tbl-ug-piping-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_ug_piping_construction")
```

\newpage

### Coarsened Regulatory Mapping: UG Piping Construction

```{r ug-piping-mapping}
#| label: tbl-ug-piping-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

ug_piping <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # DOUBLE WALL / SECONDARY CONTAINMENT
  "2I", "Double wall, metallic primary", 490, "Secondary Containment", "Compliant (All Vintages)", "§280.20(b); §280.43(g)", "Compliant", "§245.422(a)",
  "2J", "Double wall, rigid (FRP) primary", 1623, "Secondary Containment", "Compliant (All Vintages)", "§280.20(b)(1); UL 971", "Compliant", "§245.422(a)",
  "2K", "Double wall, flexible primary", 2756, "Secondary Containment", "Compliant (All Vintages)", "§280.20(b)(1)", "Compliant", "§245.422(a)",
  "2L", "TRENCH LINER", 16, "Secondary Containment", "Compliant (All Vintages)", "§280.43(g)", "Compliant", "§245.422(a)",
  "2M", "JACKETED", 15, "Secondary Containment", "Compliant (All Vintages)", "§280.20(b)", "Compliant", "§245.422(a)",
  
  # SINGLE WALL - LEGACY ONLY
  "2A", "BARE STEEL", 5870, "Single Wall (Legacy)", "Legacy: HIGH RISK", "§280.21(c) req CP upgrade", "Legacy: HIGH RISK", "§245.422(b)",
  "2A", "BARE STEEL", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.422(a)",
  "2B", "CATHODICALLY PROTECTED, METALLIC", 2137, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(b)(2); 3-yr CP test", "Legacy: Compliant", "§245.422(b); §245.432",
  "2B", "CATHODICALLY PROTECTED, METALLIC", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.422(a)",
  "2C", "COPPER", 213, "Single Wall (Legacy)", "Legacy: Conditional", "§280.20(b)(3) site assess", "Legacy: Conditional", "§245.422(b)",
  "2D", "FIBERGLASS", 6331, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(b)(1); UL 971", "Legacy: Compliant", "§245.422(b)",
  "2D", "FIBERGLASS", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.422(a)",
  "2E", "FLEXIBLE NON-METALLIC", 488, "Single Wall (Legacy)", "Legacy: Compliant", "§280.20(b)(1)", "Legacy: Compliant", "§245.422(b)",
  "2E", "FLEXIBLE NON-METALLIC", NA, "Single Wall (Legacy)", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.422(a)",
  
  # OTHER / UNKNOWN
  "288", "OTHER (COMPLIANT)", 31, "Other/Unknown", "Case-by-Case", "§280.20(b)(4)", "Case-by-Case", "§245.422",
  "299", "OTHER", 39, "Other/Unknown", "Presumed Non-Compliant", "§280.20(b)", "Presumed Non-Compliant", "§245.422",
  "2F", "UNKNOWN", 218, "Data Gap", "UNKNOWN - Verify", "N/A", "UNKNOWN - Verify", "N/A",
  "2G", "NONE", 793, "No Piping", "N/A - Direct Fill/Gravity", "§280.41(b) exemption", "N/A", "§245.445 exemption",
  "2H", "MODIFICATION OF PIPING", 15, "Maintenance Record", "Repair Record Only", "§280.33(d)", "Repair Record Only", "§245.433"
)

footnotes_ug_piping <- c(
  "Secondary Containment REQUIRED for piping installed/replaced after April 11, 2016 per §280.20 introductory paragraph.",
  "EXCEPTION: Safe suction piping meeting ALL criteria in §280.41(b)(1)(ii)(A)-(E) exempt from secondary containment.",
  "'Replaced' defined as 50%+ of piping (excl. connectors) per §280.12; triggers secondary containment for entire run.",
  "Bare steel (2A) requires cathodic protection upgrade per §280.21(c) for legacy systems.",
  "CP systems require 3-year testing by qualified tester per §280.31(b); PA requires per §245.432.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.422.html"
)

render_compliance_table(ug_piping, 
                        "UG Piping Construction: Coarsened Regulatory Compliance Mapping",
                        footnotes_ug_piping)
```

\newpage

## UG Single / Inner Wall Piping

### Raw Frequency Table

```{r ug-inner-wall-raw}
#| label: tbl-ug-inner-wall-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_ug_single_inner_wall_piping")
```

\newpage

### Coarsened Regulatory Mapping: UG Single/Inner Wall Piping

```{r ug-inner-wall-mapping}
#| label: tbl-ug-inner-wall-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

ug_inner_wall <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # NON-CORRODIBLE MATERIALS
  "28D", "FRP", 8859, "Non-Corrodible", "Compliant (Inner Wall)", "§280.20(b)(1); UL 971", "Compliant", "§245.422(a)(1)",
  "28E", "FLEX", 12507, "Non-Corrodible", "Compliant (Inner Wall)", "§280.20(b)(1)", "Compliant", "§245.422(a)(1)",
  "28I", "STAINLESS STEEL", 47, "Non-Corrodible", "Compliant (Inner Wall)", "§280.20(b)(1)", "Compliant", "§245.422(a)(1)",
  
  # METALLIC - REQUIRES CP
  "28A", "BARE STEEL", 465, "Metallic (Requires CP)", "Legacy: HIGH RISK", "§280.21(c) req CP", "Legacy: HIGH RISK", "§245.422(b)",
  "28B", "CP PROTECTED", 712, "Metallic (CP Protected)", "Legacy: Compliant", "§280.20(b)(2)", "Legacy: Compliant", "§245.422(a)(2)",
  "28C", "COPPER", 167, "Metallic (Site-Specific)", "Legacy: Conditional", "§280.20(b)(3)", "Legacy: Conditional", "§245.422(b)",
  
  # OTHER
  "2899", "OTHER", 34, "Other/Unknown", "Case-by-Case", "§280.20(b)(4)", "Case-by-Case", "§245.422",
  "28F", "UNKNOWN", 10, "Data Gap", "UNKNOWN - Verify", "N/A", "UNKNOWN - Verify", "N/A",
  "28G", "NO DISPENSING PIPING", 373, "No Piping", "N/A", "N/A", "N/A", "N/A"
)

footnotes_inner <- c(
  "This table describes the INNER (primary) wall material for double-wall piping systems.",
  "For single-wall legacy systems, this IS the piping material.",
  "FRP and Flex are non-corrodible per §280.20(b)(1); no cathodic protection required.",
  "Bare steel (28A) in legacy systems requires CP upgrade per §280.21(c).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20"
)

render_compliance_table(ug_inner_wall, 
                        "UG Single/Inner Wall Piping: Coarsened Regulatory Compliance Mapping",
                        footnotes_inner)
```

\newpage

## UG Outer Wall Piping

### Raw Frequency Table

```{r ug-outer-wall-raw}
#| label: tbl-ug-outer-wall-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_ug_outer_wall_piping")
```

\newpage

### Coarsened Regulatory Mapping: UG Outer Wall Piping

```{r ug-outer-wall-mapping}
#| label: tbl-ug-outer-wall-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

ug_outer_wall <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # SECONDARY CONTAINMENT MATERIALS
  "29D", "FRP, OUTER", 3985, "Secondary Containment", "Compliant Outer Wall", "§280.20(b)(1); §280.43(g)", "Compliant", "§245.422(a)",
  "29E", "FLEX, OUTER", 12227, "Secondary Containment", "Compliant Outer Wall", "§280.20(b)(1); §280.43(g)", "Compliant", "§245.422(a)",
  "29I", "POLY-ENCASED SS, OUTER", 19, "Secondary Containment", "Compliant Outer Wall", "§280.20(b); §280.43(g)", "Compliant", "§245.422(a)",
  
  # METALLIC OUTER WALL
  "29A", "BARE STEEL, OUTER", 204, "Metallic Outer", "Requires CP if ground contact", "§280.20(b)(2)", "Requires CP", "§245.422(a)(2)",
  "29B", "CP PROTECTED, OUTER", 51, "Metallic Outer (CP)", "Compliant Outer Wall", "§280.20(b)(2)", "Compliant", "§245.422(a)(2)",
  
  # NO OUTER WALL = SINGLE WALL
  "29N", "NONE", 6295, "Single Wall System", "Legacy: Acceptable", "§280.41(b)(1)", "Legacy: Acceptable", "§245.445",
  "29N", "NONE", NA, "Single Wall System", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.422(a)",
  
  # OTHER
  "2999", "OTHER, OUTER", 263, "Other/Unknown", "Case-by-Case", "§280.20(b)(4)", "Case-by-Case", "§245.422",
  "29F", "UNKNOWN, OUTER", 14, "Data Gap", "UNKNOWN - Verify", "N/A", "UNKNOWN - Verify", "N/A"
)

footnotes_outer <- c(
  "This table describes the OUTER (secondary) wall material for double-wall piping systems.",
  "Code 29N (NONE) indicates SINGLE-WALL piping - acceptable only for legacy installs.",
  "Post-April 11, 2016 piping installations REQUIRE secondary containment (outer wall).",
  "EXCEPTION: Safe suction piping per §280.41(b)(1)(ii)(A)-(E) exempt from secondary containment.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.43"
)

render_compliance_table(ug_outer_wall, 
                        "UG Outer Wall Piping: Coarsened Regulatory Compliance Mapping",
                        footnotes_outer)
```

\newpage

## Piping Release Detection Method

### Raw Frequency Table

```{r pipe-rd-raw}
#| label: tbl-pipe-rd-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_pipe_release_detection_method")
```

\newpage

### Coarsened Regulatory Mapping: Piping Release Detection

```{r pipe-release-detection-mapping}
#| label: tbl-pipe-rd-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

pipe_rd <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # INTERSTITIAL MONITORING
  "5D", "INTERSTITIAL MONITORING", 10888, "Secondary Containment (IM)", "Compliant (All Vintages)", "§280.43(g); §280.44(c)", "Compliant", "§245.445(1)",
  "5D", "INTERSTITIAL MONITORING", NA, "Secondary Containment (IM)", "REQUIRED: Post-4/11/16 Piping", "§280.41(b)(2)", "REQUIRED: Post-12/22/18", "§245.445(1)",
  "5L", "IM W/CONTINUOUS ALARM/SHUTOFF", 7686, "Secondary Containment (IM+)", "Compliant (All Vintages)", "§280.43(g); §280.44(a)", "Compliant", "§245.445(1)",
  
  # LINE LEAK DETECTION - PRESSURIZED PIPING
  "5A", "AUTOMATIC LINE LEAK DETECTOR", 15109, "Line Leak Detection", "Legacy Pressurized: Required", "§280.44(a); 3 gph @ 10 psi", "Required: Pressurized", "§245.445(2)(i)",
  "5A", "AUTOMATIC LINE LEAK DETECTOR", NA, "Line Leak Detection", "Post-4/11/16: Required + IM", "§280.41(b)(2)(i)", "Post-12/22/18: + IM", "§245.445(1)",
  "5K", "ELECTRONIC LINE LEAK DETECTOR", 4762, "Line Leak Detection", "Legacy Pressurized: Required", "§280.44(a)", "Required: Pressurized", "§245.445(2)(i)",
  "5K", "ELECTRONIC LINE LEAK DETECTOR", NA, "Line Leak Detection", "Post-4/11/16: Required + IM", "§280.41(b)(2)(i)", "Post-12/22/18: + IM", "§245.445(1)",
  
  # LINE TIGHTNESS TESTING
  "5B", "ANNUAL LTT (PRESSURE)", 12413, "Tightness Testing", "Legacy Pressurized: Annual", "§280.44(b); 0.1 gph @ 1.5× OP", "Annual", "§245.445(2)(ii)",
  "5B", "ANNUAL LTT (PRESSURE)", NA, "Tightness Testing", "Post-4/11/16: NON-COMPLIANT alone", "§280.41(b)(2) req IM", "Post-12/22/18: + IM", "§245.445(1)",
  "5C", "LTT - 3 YEARS (SUCTION)", 1646, "Tightness Testing", "Legacy Suction: Every 3 yrs", "§280.44(b); §280.41(b)(1)(ii)", "Every 3 yrs", "§245.445(3)",
  "5C", "LTT - 3 YEARS (SUCTION)", NA, "Tightness Testing", "Safe Suction: No RD required", "§280.41(b)(1)(ii)(A)-(E)", "Safe Suction Exempt", "§245.445(3)",
  
  # OTHER METHODS
  "5J", "STATISTICAL INVENTORY RECONCILIATION", 2558, "SIR", "Legacy: Conditional", "§280.44(c); §280.43(h)", "Conditional", "§245.445(4)",
  "5E", "GROUNDWATER MONITORING", 63, "External Monitoring", "Conditional: Site Assessment", "§280.44(c); §280.43(f)", "Conditional", "§245.445(5)",
  "5F", "VAPOR MONITORING", 33, "External Monitoring", "Conditional: Site Assessment", "§280.44(c); §280.43(e)", "Conditional", "§245.445(5)",
  "5G", "VISUAL INSPECTION", 62, "Visual Only", "Supplemental Only", "Not standalone per §280.44", "Supplemental Only", "§245.445",
  
  # NON-COMPLIANT / EXEMPT
  "5H", "NONE", 2796, "NON-COMPLIANT", "VIOLATION (Unless Safe Suction)", "§280.41(b) requires RD", "VIOLATION", "§245.445 requires RD",
  "5I", "EXEMPT", 11903, "Exempt", "Verify: Safe Suction or Exempt", "§280.41(b)(1)(ii) or §280.10", "Verify Basis", "§245.1(b); §245.445(3)"
)

footnotes_pipe_rd <- c(
  "Pressurized piping REQUIRES ALLD per §280.41(b)(1)(i)(A); must detect 3 gph at 10 psi within 1 hour.",
  "Post-April 11, 2016 piping requires Interstitial Monitoring per §280.41(b)(2); ALLD still required for pressurized.",
  "Safe Suction Exception (5I/5H may be valid): Meets ALL 5 criteria in §280.41(b)(1)(ii)(A)-(E).",
  "Annual ALLD testing required per §280.40(a)(3)(iii) - simulate leak to verify operation.",
  "LTT must detect 0.1 gph at 1.5× operating pressure per §280.44(b).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.44; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.445.html"
)

render_compliance_table(pipe_rd, 
                        "Piping Release Detection Method: Coarsened Regulatory Compliance Mapping",
                        footnotes_pipe_rd)
```

\newpage

## Line Leak Detector Shuts Off Pump

### Raw Frequency Table

```{r lld-shutoff-raw}
#| label: tbl-lld-shutoff-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_line_leak_detector_shuts_off_pump")
```

\newpage

### Coarsened Regulatory Mapping: LLD Pump Shutoff

```{r lld-shutoff-mapping}
#| label: tbl-lld-shutoff-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

lld_shutoff <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "23Y", "YES", 10425, "Automatic Shutoff", "Compliant: Best Practice", "§280.44(a) shutoff OR alarm", "Compliant", "§245.445(2)(i)",
  "23N", "NO", 17043, "Alarm Only / Manual", "Compliant: If alarm triggers", "§280.44(a) shutoff OR alarm", "Compliant if alarm", "§245.445(2)(i)"
)

footnotes_lld <- c(
  "ALLD must restrict/shutoff flow OR trigger audible/visual alarm per §280.44(a).",
  "Either shutoff (23Y) or alarm (23N with alarm) satisfies federal requirements.",
  "Automatic shutoff (23Y) is best practice for release prevention.",
  "Annual ALLD testing required per §280.40(a)(3)(iii).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.44"
)

render_compliance_table(lld_shutoff, 
                        "Line Leak Detector Pump Shutoff: Coarsened Regulatory Compliance Mapping",
                        footnotes_lld)
```

\newpage

## Pump/Delivery System

### Raw Frequency Table

```{r pump-delivery-raw}
#| label: tbl-pump-delivery-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_pump_delivery_system")
```

\newpage

### Coarsened Regulatory Mapping: Pump/Delivery System

```{r pump-delivery-mapping}
#| label: tbl-pump-delivery-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

pump_delivery <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # PRESSURIZED SYSTEMS
  "4C", "PRESSURE", 25845, "Pressurized", "Requires: ALLD + LTT or IM", "§280.41(b)(1)(i); §280.44(a)", "Requires ALLD", "§245.445(2)",
  "4C", "PRESSURE", NA, "Pressurized", "Post-4/11/16: ALLD + IM", "§280.41(b)(2)(i)", "Post-12/22/18: + IM", "§245.445(1)",
  
  # SUCTION SYSTEMS
  "4A", "SUCTION: CHECK VALVE AT PUMP", 11641, "Suction (Safe Suction Eligible)", "May qualify Safe Suction", "§280.41(b)(1)(ii)(C)-(D)", "May qualify", "§245.445(3)",
  "4B", "SUCTION: CHECK VALVE AT TANK", 3899, "Suction (NOT Safe Suction)", "Does NOT meet Safe Suction", "Fails §280.41(b)(1)(ii)(D)", "Does NOT meet", "§245.445(3)",
  "4B", "SUCTION: CHECK VALVE AT TANK", NA, "Suction (NOT Safe Suction)", "Requires: LTT every 3 yrs OR monthly", "§280.41(b)(1)(ii)", "LTT or monthly", "§245.445(3)",
  
  # OTHER
  "4D", "GRAVITY FED", 201, "Gravity", "No pumping = Limited RD options", "§280.41(b)", "Limited RD options", "§245.445",
  "4E", "NONE", 1110, "No Delivery System", "N/A - Verify tank use", "N/A", "N/A", "N/A"
)

footnotes_pump <- c(
  "PRESSURIZED piping (4C) REQUIRES automatic line leak detector per §280.41(b)(1)(i)(A).",
  "SAFE SUCTION criteria §280.41(b)(1)(ii): (A) <atm pressure, (B) slopes to tank, (C) single check valve, (D) CV at pump, (E) verification method.",
  "Code 4A may qualify for Safe Suction if ALL 5 criteria met - NO release detection required.",
  "Code 4B (CV at tank) FAILS Safe Suction criterion (D) - requires LTT every 3 years OR monthly monitoring.",
  "Post-April 11, 2016: Pressurized requires ALLD + Interstitial Monitoring per §280.41(b)(2)(i).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.41"
)

render_compliance_table(pump_delivery, 
                        "Pump/Delivery System: Coarsened Regulatory Compliance Mapping",
                        footnotes_pump)
```

\newpage

## Piping Flexible Connectors

### Raw Frequency Table

```{r flex-connectors-raw}
#| label: tbl-flex-connectors-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_piping_flexible_connectors")
```

\newpage

### Coarsened Regulatory Mapping: Piping Flexible Connectors

```{r flex-connectors-mapping}
#| label: tbl-flex-connectors-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

flex_connectors <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # CONTAINED / PROTECTED
  "PFLXD", "Completely Inside Containment Sump/Secondary", 4816, "Secondary Containment", "Compliant (All Vintages)", "§280.20; §280.43(g)", "Compliant", "§245.422",
  "PFLXE", "Completely Jacketed w/ Sealed Boot", 1596, "Secondary Containment", "Compliant (All Vintages)", "§280.20(b)", "Compliant", "§245.422",
  "PFLXF", "Not in Contact w/ Ground", 976, "Above Ground", "N/A - Not UG piping", "§280.20(b) applies to UG", "N/A", "§245.422",
  
  # CORROSION PROTECTED
  "PFLXB", "Cathodically Protected, Metallic", 2465, "Metallic (CP)", "Legacy: Compliant", "§280.20(b)(2)", "Legacy: Compliant", "§245.422(a)(2)",
  "PFLXC", "Flexible Coupling w/ Protected Metallic Ends", 53, "Metallic (CP)", "Legacy: Compliant", "§280.20(b)(2)", "Legacy: Compliant", "§245.422(a)(2)",
  
  # UNPROTECTED - HIGH RISK
  "PFLXA", "Unprotected Metallic (incl wrapped/coated)", 478, "Metallic (Unprotected)", "Legacy: HIGH RISK", "§280.21(c) req CP", "Legacy: HIGH RISK", "§245.422(b)",
  "PFLXA", "Unprotected Metallic (incl wrapped/coated)", NA, "Metallic (Unprotected)", "Post-4/11/16: NON-COMPLIANT", "§280.20(b)(2) req CP", "Post-12/22/18: NON-COMPLIANT", "§245.422(a)",
  
  # OTHER
  "88", "Other (Compliant)", 225, "Other/Unknown", "Case-by-Case", "§280.20(b)(4)", "Case-by-Case", "§245.422",
  "99", "Other (Noncompliant)", 4, "Other/Unknown", "Presumed Non-Compliant", "§280.20(b)", "Presumed Non-Compliant", "§245.422",
  "PFLXX", "None", 197, "No Flex Connectors", "N/A", "N/A", "N/A", "N/A",
  "UNK", "Unknown", 336, "Data Gap", "UNKNOWN - Verify", "N/A", "UNKNOWN - Verify", "N/A"
)

footnotes_flex <- c(
  "Flexible connectors are part of 'connected piping' per §280.12 definition.",
  "Connectors inside containment sumps (PFLXD) satisfy secondary containment.",
  "Unprotected metallic (PFLXA) in ground contact requires CP upgrade per §280.21(c).",
  "Connectors 'not in contact with ground' (PFLXF) not subject to UG piping requirements.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20"
)

render_compliance_table(flex_connectors, 
                        "Piping Flexible Connectors: Coarsened Regulatory Compliance Mapping",
                        footnotes_flex)
```

\newpage

## Flex - Tank End

### Raw Frequency Table

```{r flex-tank-end-raw}
#| label: tbl-flex-tank-end-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_flex_tank_end")
```

\newpage

### Coarsened Regulatory Mapping: Flex - Tank End

```{r flex-tank-end-mapping}
#| label: tbl-flex-tank-end-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

flex_tank_end <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # CONTAINED / PROTECTED
  "26I", "COMPLETELY INSIDE CONTAINMENT SUMP/SECONDARY", 17133, "Secondary Containment", "Compliant (All Vintages)", "§280.20; §280.43(g)", "Compliant", "§245.422",
  "26M", "COMPLETELY JACKETED W/ SEALED BOOT", 876, "Secondary Containment", "Compliant (All Vintages)", "§280.20(b)", "Compliant", "§245.422",
  "26N", "NOT IN CONTACT W/ GROUND", 1355, "Above Ground", "N/A - Not UG component", "§280.20(b) applies to UG", "N/A", "§245.422",
  
  # CORROSION PROTECTED
  "26B", "CATHODICALLY PROTECTED, METALLIC", 1676, "Metallic (CP)", "Legacy: Compliant", "§280.20(b)(2)", "Legacy: Compliant", "§245.422(a)(2)",
  
  # UNPROTECTED - HIGH RISK
  "26A", "UNPROTECTED METALLIC (INCL WRAPPED/COATED)", 51, "Metallic (Unprotected)", "Legacy: HIGH RISK", "§280.21(c) req CP", "Legacy: HIGH RISK", "§245.422(b)",
  
  # OTHER
  "2699", "OTHER", 343, "Other/Unknown", "Case-by-Case", "§280.20(b)(4)", "Case-by-Case", "§245.422",
  "26F", "UNKNOWN", 338, "Data Gap", "UNKNOWN - Verify", "N/A", "UNKNOWN - Verify", "N/A",
  "26X", "NONE", 476, "No Tank-End Flex", "N/A", "N/A", "N/A", "N/A"
)

footnotes_flex_tank <- c(
  "Tank-end flexible connectors should be inside tank-top containment sump (26I) for best protection.",
  "Contained connectors (26I, 26M) satisfy secondary containment requirements.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20"
)

render_compliance_table(flex_tank_end, 
                        "Flex - Tank End: Coarsened Regulatory Compliance Mapping",
                        footnotes_flex_tank)
```

\newpage

## Flex - Dispenser End

### Raw Frequency Table

```{r flex-dispenser-end-raw}
#| label: tbl-flex-dispenser-end-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_flex_dispenser_end")
```

\newpage

### Coarsened Regulatory Mapping: Flex - Dispenser End

```{r flex-dispenser-end-mapping}
#| label: tbl-flex-dispenser-end-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

flex_disp_end <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # CONTAINED / PROTECTED
  "27I", "COMPLETELY INSIDE CONTAINMENT SUMP/SECONDARY", 16280, "Secondary Containment", "Compliant (All Vintages)", "§280.20(f); UDC", "Compliant", "§245.422",
  "27M", "COMPLETELY JACKETED W/ SEALED BOOT", 1926, "Secondary Containment", "Compliant (All Vintages)", "§280.20(b)", "Compliant", "§245.422",
  "27N", "NOT IN CONTACT W/ GROUND", 1344, "Above Ground", "N/A - Not UG component", "§280.20(b) applies to UG", "N/A", "§245.422",
  
  # CORROSION PROTECTED
  "27B", "CATHODICALLY PROTECTED, METALLIC", 1788, "Metallic (CP)", "Legacy: Compliant", "§280.20(b)(2)", "Legacy: Compliant", "§245.422(a)(2)",
  
  # UNPROTECTED - HIGH RISK
  "27A", "UNPROTECTED METALLIC (INCL WRAPPED/COATED)", 27, "Metallic (Unprotected)", "Legacy: HIGH RISK", "§280.21(c) req CP", "Legacy: HIGH RISK", "§245.422(b)",
  
  # OTHER
  "2799", "OTHER", 190, "Other/Unknown", "Case-by-Case", "§280.20(b)(4)", "Case-by-Case", "§245.422",
  "27F", "UNKNOWN", 34, "Data Gap", "UNKNOWN - Verify", "N/A", "UNKNOWN - Verify", "N/A",
  "27X", "NONE", 763, "No Dispenser-End Flex", "N/A", "N/A", "N/A", "N/A"
)

footnotes_flex_disp <- c(
  "Dispenser-end connectors should be inside under-dispenser containment (UDC) per §280.20(f).",
  "UDC required for new dispenser systems installed after April 11, 2016.",
  "Contained connectors (27I, 27M) satisfy secondary containment requirements.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20"
)

render_compliance_table(flex_disp_end, 
                        "Flex - Dispenser End: Coarsened Regulatory Compliance Mapping",
                        footnotes_flex_disp)
```

\newpage

## AG Piping Construction & Corrosion Protection

### Raw Frequency Table

```{r ag-piping-raw}
#| label: tbl-ag-piping-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_ag_piping_construction_corrosion_prot___")
```

\newpage

### Coarsened Regulatory Mapping: AG Piping Construction

```{r ag-piping-mapping}
#| label: tbl-ag-piping-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

ag_piping <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # DOUBLE WALL
  "3I", "DOUBLE WALL METALLIC PRIMARY", 19, "Secondary Containment", "Compliant", "§280.20(b)", "Compliant", "§245.422(a)",
  "3J", "DOUBLE WALL RIGID (FRP) PRIMARY", 11, "Secondary Containment", "Compliant", "§280.20(b)(1)", "Compliant", "§245.422(a)",
  "3K", "DOUBLE WALL FLEXIBLE PRIMARY", 8, "Secondary Containment", "Compliant", "§280.20(b)(1)", "Compliant", "§245.422(a)",
  
  # SINGLE WALL - ABOVE GROUND (Different requirements)
  "3A", "CARBON STEEL", 615, "Single Wall (AG)", "AG: Not subject to §280.20(b)", "AG piping different reqs", "AG: PA Ch. 245 Subchap F", "§245.501-545",
  "3B", "CATHODICALLY PROTECTED, METALLIC", 72, "Single Wall (CP)", "AG: Best Practice", "AG piping different reqs", "AG: Best Practice", "§245.501-545",
  "3C", "COPPER", 30, "Single Wall (AG)", "AG: Acceptable", "AG piping different reqs", "AG: Acceptable", "§245.501-545",
  "3D", "FIBERGLASS", 40, "Single Wall (AG)", "AG: Non-corrodible", "AG piping different reqs", "AG: Acceptable", "§245.501-545",
  "3E", "FLEXIBLE NON-METALLIC", 29, "Single Wall (AG)", "AG: Non-corrodible", "AG piping different reqs", "AG: Acceptable", "§245.501-545",
  "3F", "PVC", 10, "Single Wall (AG)", "AG: Non-corrodible", "AG piping different reqs", "AG: Acceptable", "§245.501-545",
  "3L", "STAINLESS STEEL", 9, "Single Wall (AG)", "AG: Corrosion resistant", "AG piping different reqs", "AG: Acceptable", "§245.501-545",
  
  # OTHER
  "388", "OTHER (COMPLIANT)", 156, "Other/Unknown", "Case-by-Case", "N/A", "Case-by-Case", "§245.501-545",
  "399", "OTHER", 21, "Other/Unknown", "Case-by-Case", "N/A", "Case-by-Case", "§245.501-545",
  "3G", "NONE", 448, "No AG Piping", "N/A", "N/A", "N/A", "N/A",
  "3H", "PIPING MODIFICATION", 5, "Maintenance Record", "Repair Record Only", "§280.33", "Repair Record", "§245.433"
)

footnotes_ag <- c(
  "ABOVEGROUND piping NOT subject to 40 CFR 280 Subpart B (§280.20(b)) UG requirements.",
  "40 CFR 280 applies to USTs with >10% volume underground; AG piping requirements differ.",
  "PA regulates ASTs under 25 Pa. Code Ch. 245 Subchapter F (§245.501-545).",
  "Secondary containment for AG piping is best practice but not federally mandated.",
  "URLs: PA AST: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/subchapFtoc.html"
)

render_compliance_table(ag_piping, 
                        "AG Piping Construction: Coarsened Regulatory Compliance Mapping",
                        footnotes_ag)
```

\newpage

# Spill & Overfill Prevention

## Spill Prevention

### Raw Frequency Table

```{r spill-prev-raw}
#| label: tbl-spill-prev-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_spill_prevention")
```

\newpage

### Coarsened Regulatory Mapping: Spill Prevention

```{r spill-prevention-mapping}
#| label: tbl-spill-prev-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

spill_prev <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # COMPLIANT
  "6Y", "YES", 29689, "Spill Prevention Installed", "Compliant", "§280.20(c)(1)(i)", "Compliant", "§245.421(b)(6)",
  "6D", "DOUBLE WALL SPILL PREV", 2564, "Double Wall (Best Practice)", "Compliant + Enhanced", "§280.35(a)(1)(i)", "Compliant + Enhanced", "§245.437(a)(1)",
  "6S", "SINGLE WALL SPILL PREV", 4680, "Single Wall", "Compliant", "§280.20(c)(1)(i)", "Compliant", "§245.421(b)(6)",
  
  # NON-COMPLIANT
  "6N", "NO", 5543, "NO Spill Prevention", "NON-COMPLIANT", "§280.20(c)(1)(i) required", "NON-COMPLIANT", "§245.421(b)(6) required",
  
  # EXEMPT
  "6E", "EXEMPT", 512, "Exempt", "Verify Exemption Basis", "§280.20(c)(2)-(3)", "Verify Basis", "§245.421(b)(6)"
)

footnotes_spill <- c(
  "Spill prevention (catchment basin/spill bucket) REQUIRED per §280.20(c)(1)(i) for all regulated USTs.",
  "Testing every 3 years required per §280.35(a)(1)(ii); initial test by October 13, 2018 for existing systems.",
  "Double-wall spill prevention (6D) with periodic monitoring may substitute for 3-year testing per §280.35(a)(1)(i).",
  "Exemptions per §280.20(c)(2): Tanks with permanently affixed top, fuel oil tanks meeting §280.10(c) criteria.",
  "PA requires 3-year testing or double-wall monitoring per §245.437(a)(1).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.35; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.437.html"
)

render_compliance_table(spill_prev, 
                        "Spill Prevention: Coarsened Regulatory Compliance Mapping",
                        footnotes_spill)
```

\newpage

## Overfill Prevention

### Raw Frequency Table

```{r overfill-prev-raw}
#| label: tbl-overfill-prev-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_overfill_prevention")
```

\newpage

### Coarsened Regulatory Mapping: Overfill Prevention

```{r overfill-prevention-mapping}
#| label: tbl-overfill-prev-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

overfill_prev <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  # COMPLIANT METHODS
  "7S", "DROP TUBE SHUTOFF DEVICE", 24814, "Automatic Shutoff (≤95%)", "Compliant (All Vintages)", "§280.20(c)(1)(ii)(A)", "Compliant", "§245.421(b)(7)",
  "7A", "OVERFILL ALARM", 9490, "High-Level Alarm (≤90%)", "Compliant (All Vintages)", "§280.20(c)(1)(ii)(B)", "Compliant", "§245.421(b)(7)",
  "7Y", "YES", 3550, "Overfill Prevention Installed", "Compliant - Verify Type", "§280.20(c)(1)(ii)", "Compliant - Verify Type", "§245.421(b)(7)",
  
  # BALL FLOAT VALVE - SUNSET
  "7B", "BALL FLOAT VALVE", 2598, "Ball Float (Vent Restrictor)", "Pre-10/13/15: GRANDFATHERED", "§280.20(c)(3)", "Pre-12/22/18: GRANDFATHERED", "§245.421(b)(7)",
  "7B", "BALL FLOAT VALVE", NA, "Ball Float (Vent Restrictor)", "Post-10/13/15: PROHIBITED", "§280.20(c)(3) prohibits", "Post-12/22/18: PROHIBITED", "§245.421(b)(7)",
  "7B", "BALL FLOAT VALVE", NA, "Ball Float (Vent Restrictor)", "Replacement: PROHIBITED", "§280.20(c)(3)", "Replacement: PROHIBITED", "§245.421(b)(7)",
  
  # NON-COMPLIANT
  "7N", "NO", 6183, "NO Overfill Prevention", "NON-COMPLIANT", "§280.20(c)(1)(ii) required", "NON-COMPLIANT", "§245.421(b)(7) required",
  
  # EXEMPT
  "7E", "EXEMPT", 885, "Exempt", "Verify Exemption Basis", "§280.20(c)(2)-(3)", "Verify Basis", "§245.421(b)(7)"
)

footnotes_overfill <- c(
  "Overfill prevention REQUIRED per §280.20(c)(1)(ii) for all regulated USTs.",
  "BALL FLOAT VALVE (7B) PROHIBITED for new install/replacement after October 13, 2015 per §280.20(c)(3).",
  "Existing ball floats installed before 10/13/15 may continue if functional (grandfathered).",
  "When ball float requires replacement, must use automatic shutoff (7S) or alarm (7A).",
  "Inspection every 3 years required per §280.35(a)(2); verify activation level per §280.20(c).",
  "PA effective date December 22, 2018 for ball float prohibition per 48 Pa.B. 7875.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.421.html"
)

render_compliance_table(overfill_prev, 
                        "Overfill Prevention: Coarsened Regulatory Compliance Mapping",
                        footnotes_overfill)
```

\newpage

# Containment Systems

## UST Total Secondarily Contained

### Raw Frequency Table

```{r ust-secondary-raw}
#| label: tbl-ust-secondary-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_ust_total_secondarily_contained")
```

\newpage

### Coarsened Regulatory Mapping: UST Secondarily Contained

```{r ust-secondary-mapping}
#| label: tbl-ust-secondary-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

ust_secondary <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "18Y", "YES", 12244, "Secondarily Contained", "Compliant (All Vintages)", "§280.20; §280.43(g)", "Compliant", "§245.421(a)",
  "18Y", "YES", NA, "Secondarily Contained", "REQUIRED: Post-4/11/16", "§280.20 intro para", "REQUIRED: Post-12/22/18", "§245.421(a)",
  
  "18N", "NO", 20287, "NOT Secondarily Contained", "Legacy: Acceptable", "§280.41(a)(1); §280.21", "Legacy: Acceptable", "§245.421(b)",
  "18N", "NO", NA, "NOT Secondarily Contained", "Post-4/11/16: NON-COMPLIANT", "§280.20 intro para", "Post-12/22/18: NON-COMPLIANT", "§245.421(a)"
)

footnotes_ust_sec <- c(
  "Secondary containment REQUIRED for all UST systems installed/replaced after April 11, 2016.",
  "Secondary containment = tank + piping + containment sumps all double-walled with interstitial monitoring.",
  "Legacy systems (18N pre-4/11/16) acceptable with monthly release detection per §280.41.",
  "PA effective date December 22, 2018 for secondary containment mandate.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20"
)

render_compliance_table(ust_secondary, 
                        "UST Secondarily Contained: Coarsened Regulatory Compliance Mapping",
                        footnotes_ust_sec)
```

\newpage

## Tank-Top Containment Sumps

### Raw Frequency Table

```{r tank-top-sumps-raw}
#| label: tbl-tank-top-sumps-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_tank_top_containment_sumps")
```

\newpage

### Coarsened Regulatory Mapping: Tank-Top Containment Sumps

```{r tank-top-sumps-mapping}
#| label: tbl-tank-top-sumps-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

tank_top_sumps <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "21A", "AT ALL PENETRATIONS", 18857, "Full Coverage", "Compliant (Best Practice)", "§280.35; §280.12 def", "Compliant", "§245.437",
  "21S", "AT SOME PENETRATIONS", 1127, "Partial Coverage", "Conditional: Legacy acceptable", "§280.35", "Conditional", "§245.437",
  "21S", "AT SOME PENETRATIONS", NA, "Partial Coverage", "Post-4/11/16: May not satisfy IM", "§280.43(g) req IM all penetrations", "Post-12/22/18: Verify", "§245.444(1)",
  "21N", "NONE", 7554, "No Tank-Top Sumps", "Legacy: Acceptable", "Not required for legacy", "Legacy: Acceptable", "Not required legacy",
  "21N", "NONE", NA, "No Tank-Top Sumps", "Post-4/11/16: Verify IM method", "§280.43(g) options", "Post-12/22/18: Verify", "§245.444(1)"
)

footnotes_tank_sumps <- c(
  "Containment sumps protect piping connections at tank top (STP sump).",
  "Per §280.12: Containment sump used for interstitial monitoring is part of secondary containment.",
  "Testing every 3 years required per §280.35(a)(1)(ii) if used for IM; double-wall with monitoring may substitute.",
  "Post-4/11/16 systems using IM must monitor all penetrations; partial (21S) may not satisfy.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.35"
)

render_compliance_table(tank_top_sumps, 
                        "Tank-Top Containment Sumps: Coarsened Regulatory Compliance Mapping",
                        footnotes_tank_sumps)
```

\newpage

## Under-Dispenser Containment

### Raw Frequency Table

```{r udc-raw}
#| label: tbl-udc-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_under_dispenser_containment")
```

\newpage

### Coarsened Regulatory Mapping: Under-Dispenser Containment

```{r udc-mapping}
#| label: tbl-udc-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

udc <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "22A", "AT ALL DISPENSERS", 18566, "Full UDC Coverage", "Compliant (Best Practice)", "§280.20(f)", "Compliant", "§245.421(b)(8)",
  "22A", "AT ALL DISPENSERS", NA, "Full UDC Coverage", "REQUIRED: New dispensers post-4/11/16", "§280.20(f)(1)", "REQUIRED: Post-12/22/18", "§245.421(b)(8)",
  
  "22S", "AT SOME DISPENSERS", 253, "Partial UDC Coverage", "Conditional: Legacy acceptable", "§280.20(f)", "Conditional", "§245.421(b)(8)",
  "22S", "AT SOME DISPENSERS", NA, "Partial UDC Coverage", "Post-4/11/16 dispensers: Require UDC", "§280.20(f)(1)", "Post-12/22/18: Require UDC", "§245.421(b)(8)",
  
  "22N", "NONE", 8667, "No UDC", "Legacy: Acceptable", "Not required pre-4/11/16", "Legacy: Acceptable", "Not required pre-12/22/18",
  "22N", "NONE", NA, "No UDC", "Post-4/11/16 dispensers: NON-COMPLIANT", "§280.20(f)(1) requires", "Post-12/22/18: NON-COMPLIANT", "§245.421(b)(8)"
)

footnotes_udc <- c(
  "UDC REQUIRED for new dispenser systems installed after April 11, 2016 per §280.20(f).",
  "'New dispenser system' = dispenser AND connecting equipment installed per §280.20(f)(1).",
  "Partial component replacement does NOT trigger UDC requirement.",
  "UDC must be liquid-tight on sides, bottom, and penetrations per §280.20(f)(2).",
  "UDC must allow visual inspection/access OR periodic monitoring.",
  "PA effective date December 22, 2018 per 48 Pa.B. 7875.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.20"
)

render_compliance_table(udc, 
                        "Under-Dispenser Containment: Coarsened Regulatory Compliance Mapping",
                        footnotes_udc)
```

\newpage

# Vapor Recovery Systems

## Vapor Recovery (Summary)

### Raw Frequency Table

```{r vapor-recovery-raw}
#| label: tbl-vapor-recovery-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_vapor_recovery")
```

\newpage

### Coarsened Regulatory Mapping: Vapor Recovery

```{r vapor-recovery-mapping}
#| label: tbl-vapor-recovery-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

vapor_recovery <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "11A", "STAGE I INSTALLED", 3693, "Stage I Only", "Clean Air Act (not 40 CFR 280)", "42 U.S.C. §7511a(b)(3)", "25 Pa. Code Ch. 129", "§129.82",
  "11B", "STAGE II INSTALLED", 89, "Stage II Only", "Clean Air Act (not 40 CFR 280)", "42 U.S.C. §7511a(b)(3)", "25 Pa. Code Ch. 129", "§129.82",
  "11C", "STAGE I AND STAGE II INSTALLED", 774, "Stage I + II", "Clean Air Act (not 40 CFR 280)", "42 U.S.C. §7511a(b)(3)", "25 Pa. Code Ch. 129", "§129.82",
  "11D", "NONE", 4494, "No Vapor Recovery", "May be acceptable - check area", "Air quality area-dependent", "Check county status", "§129.82"
)

footnotes_vapor <- c(
  "VAPOR RECOVERY is NOT regulated under 40 CFR Part 280 (UST regulations).",
  "Vapor recovery falls under Clean Air Act Section 182(b)(3) for ozone non-attainment areas.",
  "Stage II requirements vary by county based on ozone attainment status.",
  "Many areas have DECOMMISSIONED Stage II due to ORVR vehicle technology.",
  "PA regulates vapor recovery under 25 Pa. Code Chapter 129 (air quality), not Chapter 245 (tanks).",
  "Consult PA DEP Air Quality for county-specific requirements.",
  "URLs: PA Air Quality: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter129/chap129toc.html"
)

render_compliance_table(vapor_recovery, 
                        "Vapor Recovery: Coarsened Regulatory Compliance Mapping",
                        footnotes_vapor)
```

\newpage

## Stage I Vapor Recovery

### Raw Frequency Table

```{r stage-i-raw}
#| label: tbl-stage-i-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_stage_i_vapor_recovery")
```

\newpage

### Coarsened Regulatory Mapping: Stage I Vapor Recovery

```{r stage-i-mapping}
#| label: tbl-stage-i-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

stage_i <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "19A", "COAX", 8099, "Coaxial System", "CAA Area-Dependent", "42 U.S.C. §7511a(b)(3)", "§129.82 Area-Dependent", "25 Pa. Code §129.82",
  "19B", "2 POINT", 13101, "Two-Point System", "CAA Area-Dependent", "42 U.S.C. §7511a(b)(3)", "§129.82 Area-Dependent", "25 Pa. Code §129.82",
  "19N", "NONE OR INCOMPLETE", 12382, "No/Incomplete Stage I", "Check if required in area", "42 U.S.C. §7511a(b)(3)", "Check county status", "25 Pa. Code §129.82",
  "2I", "Double wall, metallic primary", 1, "Data Error - Piping Code", "Data Quality Issue", "N/A", "Data Quality Issue", "N/A"
)

footnotes_stage_i <- c(
  "Stage I captures vapors during bulk fuel delivery (truck to tank).",
  "COAX (19A): Single fill pipe with coaxial vapor return.",
  "2-POINT (19B): Separate fill and vapor return openings.",
  "Requirements depend on county ozone attainment status under Clean Air Act.",
  "Code 2I appears to be data entry error (piping code in vapor recovery field).",
  "URLs: PA Air Quality: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter129/s129.82.html"
)

render_compliance_table(stage_i, 
                        "Stage I Vapor Recovery: Coarsened Regulatory Compliance Mapping",
                        footnotes_stage_i)
```

\newpage

## Stage II Vapor Recovery

### Raw Frequency Table

```{r stage-ii-raw}
#| label: tbl-stage-ii-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_stage_ii_vapor_recovery")
```

\newpage

### Coarsened Regulatory Mapping: Stage II Vapor Recovery

```{r stage-ii-mapping}
#| label: tbl-stage-ii-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

stage_ii <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "20A", "COMPLETE BALANCE SYSTEM", 623, "Balance System", "LARGELY OBSOLETE", "EPA ORVR Waiver 2012", "Decommissioning allowed", "25 Pa. Code §129.82",
  "20B", "COMPLETE ASSIST SYSTEM", 2256, "Assist System", "LARGELY OBSOLETE", "EPA ORVR Waiver 2012", "Decommissioning allowed", "25 Pa. Code §129.82",
  "20C", "UG PIPING ONLY", 6248, "Partial Infrastructure", "Infrastructure for Stage II", "N/A - Equipment not active", "Infrastructure only", "25 Pa. Code §129.82",
  "20D", "DECOMMISSIONED", 2359, "Decommissioned", "Compliant with waiver", "EPA ORVR Waiver", "Compliant", "25 Pa. Code §129.82",
  "20N", "NONE", 21258, "No Stage II", "Generally acceptable now", "EPA ORVR Waiver", "Generally acceptable", "25 Pa. Code §129.82"
)

footnotes_stage_ii <- c(
  "Stage II captures vapors during vehicle refueling (dispenser to vehicle).",
  "EPA issued nationwide ORVR (Onboard Refueling Vapor Recovery) waiver effective 2012.",
  "ORVR-equipped vehicles capture vapors; Stage II at pump largely unnecessary.",
  "Most states allow/require Stage II DECOMMISSIONING (20D) for ORVR compatibility.",
  "Balance (20A) uses pressure differential; Assist (20B) uses vacuum pump.",
  "Decommissioned (20D) is now the expected/preferred status in most areas.",
  "URLs: EPA ORVR: https://www.epa.gov/gasoline-standards/gasoline-reid-vapor-pressure"
)

render_compliance_table(stage_ii, 
                        "Stage II Vapor Recovery: Coarsened Regulatory Compliance Mapping",
                        footnotes_stage_ii)
```

\newpage

# Appendix: Key Regulatory Dates Reference

```{r key-dates}
#| label: tbl-key-dates
#| echo: false
#| results: asis
#| warning: false
#| message: false

key_dates <- tribble(
  ~Date, ~Event, ~Federal_Citation, ~PA_Citation,
  "December 22, 1988", "Original UST regulations published", "53 FR 37082", "Act 32 of 1989",
  "December 22, 1998", "Compliance deadline for existing tanks", "53 FR 37082", "25 Pa. Code Ch. 245",
  "July 15, 2015", "2015 Final Rule published", "80 FR 41566", "N/A",
  "October 13, 2015", "2015 Final Rule EFFECTIVE DATE", "80 FR 41566", "N/A",
  "October 13, 2015", "Ball float valve PROHIBITION begins", "§280.20(c)(3)", "§245.421(b)(7)",
  "April 11, 2016", "Secondary containment REQUIRED (new/replaced)", "§280.20 intro", "N/A",
  "October 13, 2018", "Walkthrough, testing, training deadlines", "§280.35, §280.36, §280.243", "N/A",
  "December 22, 2018", "PA adopts 2015 federal requirements", "N/A", "48 Pa.B. 7875",
  "December 22, 2018", "PA secondary containment effective", "N/A", "§245.421(a)"
)

kable(key_dates, 
      booktabs = TRUE, 
      caption = "Key Regulatory Dates: Federal and Pennsylvania UST Requirements") %>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  column_spec(1, width = "2.5cm") %>%
  column_spec(2, width = "5cm") %>%
  column_spec(3, width = "3cm") %>%
  column_spec(4, width = "3cm")
```

\newpage

# Appendix: Citation URLs

## Federal Sources

- **40 CFR Part 280 (eCFR)**: https://www.ecfr.gov/current/title-40/chapter-I/subchapter-I/part-280
- **2015 Final Rule (Federal Register)**: https://www.federalregister.gov/documents/2015/07/15/2015-15914/revising-underground-storage-tank-regulations-revisions-to-existing-requirements-and-new
- **EPA UST Technical Compendium**: https://www.epa.gov/ust/underground-storage-tank-technical-compendium-about-2015-ust-regulation
- **EPA MUSTs for USTs Guide**: https://www.epa.gov/sites/default/files/2015-12/documents/musts_for_usts.pdf

## Pennsylvania Sources

- **25 Pa. Code Chapter 245**: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/chap245toc.html
- **25 Pa. Code Subchapter E (UST Technical Standards)**: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/subchapEtoc.html
- **PA DEP Storage Tanks**: https://www.pa.gov/agencies/dep/programs-and-services/land/storage-tanks/underground-storage-tanks
- **USTIF**: https://ustif.pa.gov/
- **25 Pa. Code Chapter 977 (USTIF)**: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter977/chap977toc.html

\newpage

# Tank Upgrades & Retrofits

## Tank Upgrade

### Raw Frequency Table

```{r tank-upgrade-raw}
#| label: tbl-tank-upgrade-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_tank_upgrade")
```

\newpage

### Coarsened Regulatory Mapping: Tank Upgrade

```{r tank-upgrade-mapping}
#| label: tbl-tank-upgrade-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

tank_upgrade <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "10A", "TANK WAS RETROFITTED WITH CATHODIC PROTECTION", 1689, "CP Retrofit", "Legacy Upgrade: Compliant", "§280.21(b)(2)", "Legacy Upgrade: Compliant", "§245.421(b)",
  "10A", "TANK WAS RETROFITTED WITH CATHODIC PROTECTION", NA, "CP Retrofit", "Must meet §280.31 monitoring", "§280.31(b)-(c); 3-yr test", "Must meet monitoring", "§245.432",
  
  "10B", "TANK WAS RETROFITTED WITH LINING", 859, "Interior Lining", "Legacy Upgrade: Compliant", "§280.21(b)(1)", "Legacy Upgrade: Compliant", "§245.421(b)",
  "10B", "TANK WAS RETROFITTED WITH LINING", NA, "Interior Lining", "Inspection: 10 yrs, then 5 yrs", "§280.21(b)(1)(ii)", "Inspection required", "§245.421(b)",
  
  "10C", "TANK WAS RETROFITTED WITH RIGID BLADDER (EX. PHOENIX SYS)", 4, "Bladder System", "Legacy Upgrade: Conditional", "§280.21(b)(1)(iii); §280.20(a)(5)", "Conditional", "§245.421(b)"
)

footnotes_upgrade <- c(
  "Tank upgrades were compliance options under 1988 regulations for existing bare steel tanks.",
  "CP Retrofit (10A): Per §280.21(b)(2), must meet §280.20(a)(2) design + §280.31 monitoring.",
  "Interior Lining (10B): Must be inspected within 10 years of lining per §280.21(b)(1)(ii), then every 5 years.",
  "Bladder systems (10C) rarely used; may require agency approval under §280.20(a)(5).",
  "These upgrades were required by December 22, 1998 deadline; NOT valid for new installations.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.21"
)

render_compliance_table(tank_upgrade, 
                        "Tank Upgrade: Coarsened Regulatory Compliance Mapping",
                        footnotes_upgrade)
```

\newpage

# Emergency Generator USTs

## Emergency Generator

### Raw Frequency Table

```{r emer-gen-raw}
#| label: tbl-emer-gen-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_emergency_generator")
```

\newpage

### Coarsened Regulatory Mapping: Emergency Generator USTs

```{r emer-gen-mapping}
#| label: tbl-emer-gen-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

emer_gen <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "25Y", "YES - EMER GEN", 678, "Emergency Generator UST", "Subject to §280.10(a)(1) exemption provisions", "§280.10(a)(1)(ii)", "Deferred Compliance", "§245.403(b)",
  "25Y", "YES - EMER GEN", NA, "Emergency Generator UST", "Install ≤11/10/07: Comply by 12/21/2020", "§280.252(a)(1)", "Comply by 12/21/2020", "§245.403(b)(1)",
  "25Y", "YES - EMER GEN", NA, "Emergency Generator UST", "Install 11/11/07-12/22/18: Comply by 12/22/2019", "§280.252(a)(2)", "Comply by 12/22/2019", "§245.403(b)(2)",
  "25Y", "YES - EMER GEN", NA, "Emergency Generator UST", "Install after 12/22/18: Comply at install", "§280.252(a)(3)", "Comply at install", "§245.403(b)(3)",
  
  "25N", "NO - EMER GEN", 21543, "Not Emergency Generator", "Standard UST requirements apply", "§280.20 et seq.", "Standard requirements", "§245.401 et seq."
)

footnotes_emer <- c(
  "Emergency Generator USTs had DEFERRED compliance deadlines under 2015 Final Rule.",
  "KEY DATES - Based on tank INSTALLATION date:",
  "  • Installed on/before November 10, 2007 → Full compliance by December 21, 2020",
  "  • Installed November 11, 2007 – December 22, 2018 → Full compliance by December 22, 2019",
  "  • Installed after December 22, 2018 → Compliance required at installation",
  "As of January 2026, ALL emergency generator deadlines have passed - full compliance required.",
  "Emergency generators are NOT exempt from UST regulations per §280.10(a)(1).",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.252; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.403.html"
)

render_compliance_table(emer_gen, 
                        "Emergency Generator USTs: Coarsened Regulatory Compliance Mapping",
                        footnotes_emer)
```

\newpage

# Administrative & Permitting

## Fire Marshal Permit

### Raw Frequency Table

```{r fire-marshal-raw}
#| label: tbl-fire-marshal-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_fire_marshal_permit")
```

\newpage

### Coarsened Regulatory Mapping: Fire Marshal Permit

```{r fire-marshal-mapping}
#| label: tbl-fire-marshal-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

fire_marshal <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "9A", "ISSUED PRIOR TO AUGUST 5, 1989", 3316, "Pre-Act 32 Permit", "N/A (State admin)", "N/A", "Legacy Permit", "Act 32 of 1989",
  "9A", "ISSUED PRIOR TO AUGUST 5, 1989", NA, "Pre-Act 32 Permit", "N/A", "N/A", "May lack Ch. 245 compliance", "§245.411",
  
  "9B", "ISSUED ON OR AFTER AUGUST 5, 1989", 1288, "Post-Act 32 Permit", "N/A (State admin)", "N/A", "Standard Permit", "§245.411; Act 32",
  
  "9C", "NO PERMIT OBTAINED", 3709, "No Permit", "Federal: NO permit req", "40 CFR 280 no permit req", "PA: Permit REQUIRED", "§245.411(a)",
  "9C", "NO PERMIT OBTAINED", NA, "No Permit", "N/A", "N/A", "VIOLATION if in PA jurisdiction", "§245.411(a)",
  
  "9D", "TANKS NOT REGULATED BY FIRE MARSHAL", 268, "Exempt from FM", "N/A", "N/A", "Verify exemption basis", "§245.1(b)"
)

footnotes_fire <- c(
  "Fire Marshal permits are PENNSYLVANIA-specific administrative requirement.",
  "August 5, 1989 = Effective date of PA Storage Tank Act (Act 32 of 1989).",
  "Federal UST regulations (40 CFR 280) do NOT require permits; PA does.",
  "Pre-Act 32 permits (9A) may indicate legacy tanks requiring upgrade verification.",
  "No Permit (9C) is a VIOLATION of PA requirements per §245.411(a).",
  "USTIF eligibility requires valid permits per 25 Pa. Code §977.31(a)(4).",
  "URLs: PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.411.html"
)

render_compliance_table(fire_marshal, 
                        "Fire Marshal Permit: Coarsened Regulatory Compliance Mapping",
                        footnotes_fire)
```

\newpage

## Registration Certificate

### Raw Frequency Table

```{r reg-cert-raw}
#| label: tbl-reg-cert-raw
#| echo: false
#| results: asis
#| tbl-pos: 'H'

include_table("004_comp_registration_certificate")
```

\newpage

### Coarsened Regulatory Mapping: Registration Certificate

```{r reg-cert-mapping}
#| label: tbl-reg-cert-compliance
#| echo: false
#| results: asis
#| warning: false
#| message: false

reg_cert <- tribble(
  ~CODE, ~COMPONENT_TYPE, ~N, ~Coarsened_Category, ~Federal_Status, ~Federal_Citation, ~PA_Status, ~PA_Citation,
  
  "8Y", "YES", 11677, "Registered", "Federal: Notification req", "§280.22; §280.34", "PA: Registration required", "§245.411; §245.412",
  "8Y", "YES", NA, "Registered", "N/A", "N/A", "USTIF eligible (if current)", "§977.31(a)(3)",
  
  "8N", "NO", 1397, "NOT Registered", "Federal: VIOLATION", "§280.22 requires notification", "PA: VIOLATION", "§245.411(a)",
  "8N", "NO", NA, "NOT Registered", "Cannot operate legally", "§280.22", "USTIF INELIGIBLE", "§977.31(a)(3)"
)

footnotes_reg <- c(
  "Registration is MANDATORY under both federal and PA law.",
  "Federal: Notification within 30 days of installation per §280.22.",
  "PA: Registration certificate + annual renewal required per §245.411-412.",
  "Unregistered tanks (8N) are VIOLATIONS and INELIGIBLE for USTIF coverage.",
  "USTIF §977.31(a)(3): Tank must be 'currently registered' for claim eligibility.",
  "Registration status can be verified via PA DEP eFACTS system.",
  "URLs: Federal: https://www.ecfr.gov/current/title-40/section-280.22; PA: https://www.pacodeandbulletin.gov/Display/pacode?file=/secure/pacode/data/025/chapter245/s245.411.html"
)

render_compliance_table(reg_cert, 
                        "Registration Certificate: Coarsened Regulatory Compliance Mapping",
                        footnotes_reg)
```

\newpage

# Appendix: Compliance Status Decision Tree

```{r decision-tree}
#| label: fig-decision-tree
#| echo: false
#| results: asis
#| warning: false
#| message: false
#| fig-cap: "Simplified Compliance Status Decision Framework"

cat("
\\begin{center}
\\textbf{UST Compliance Status Decision Framework}
\\end{center}

\\textbf{Step 1: Determine Installation/Replacement Date}
\\begin{itemize}
  \\item Pre-December 22, 1998: Subject to upgrade requirements (§280.21)
  \\item December 22, 1998 - April 10, 2016: 'Legacy' system rules
  \\item April 11, 2016 - Present (Federal) / December 22, 2018 - Present (PA): Secondary containment REQUIRED
\\end{itemize}

\\textbf{Step 2: For Post-April 11, 2016 Installations}
\\begin{itemize}
  \\item Tank: Must be double-wall with interstitial monitoring

  \\item Piping: Must be double-wall with interstitial monitoring
  \\item Dispenser: Must have under-dispenser containment (UDC)
  \\item Exception: Safe suction piping meeting ALL 5 criteria (§280.41(b)(1)(ii))
\\end{itemize}

\\textbf{Step 3: For Legacy Installations (Pre-April 11, 2016)}
\\begin{itemize}
  \\item Single-wall tanks: Acceptable with monthly release detection
  \\item Single-wall piping: Acceptable with ALLD (pressurized) or LTT/monitoring (suction)
  \\item Ball float valve: Acceptable if installed before October 13, 2015
  \\item Upgrades (CP, lining): Must meet ongoing inspection requirements
\\end{itemize}

\\textbf{Step 4: Verify Administrative Compliance}
\\begin{itemize}
  \\item Registration current? (§245.411)
  \\item Annual fees paid? (§977.31(a)(2))
  \\item Certified installers used? (§245.101-141)
  \\item Operator training current? (§280.243)
\\end{itemize}
")
```

\newpage

# Appendix: USTIF Eligibility Checklist

Per 25 Pa. Code §977.31, eligibility for USTIF coverage requires ALL of the following:

```{r ustif-checklist}
#| label: tbl-ustif-checklist
#| echo: false
#| results: asis
#| warning: false
#| message: false

ustif_checklist <- tribble(
  ~Requirement, ~Citation, ~Component_Link,
  "Claimant is owner, operator, landowner, or certified installer/inspector", "§977.31(a)(1)", "N/A",
  "Underground Storage Tank Indemnification Fund fee current at time of release", "§977.31(a)(2)", "Registration Certificate",
  "Tank currently registered with DEP", "§977.31(a)(3)", "Registration Certificate (8Y)",
  "Permits and certifications obtained before tank installation", "§977.31(a)(4)", "Fire Marshal Permit (9A/9B)",
  "Confirmed release occurred on/after February 1, 1994", "§977.31(a)(5)", "N/A",
  "Claimant cooperates with Fund and DEP", "§977.31(a)(6)", "N/A",
  "Notification to Fund within 60 days of release discovery", "§977.31(a)(7)", "N/A"
)

kable(ustif_checklist, 
      booktabs = TRUE, 
      caption = "USTIF Eligibility Requirements (25 Pa. Code §977.31)") %>%
  kable_styling(latex_options = c("scale_down", "hold_position")) %>%
  column_spec(1, width = "8cm") %>%
  column_spec(2, width = "3cm") %>%
  column_spec(3, width = "4cm")
```

**Coverage Limits (25 Pa. Code §977.33):**

- Maximum per tank per occurrence: \$1,500,000
- Annual aggregate: \$1,500,000
- Deductible: \$5,000 per tank (scales with tank count per §245.707)

**Deductible Scale (25 Pa. Code §245.707):**

| Tanks | Deductible |
|-------|------------|
| 1-6   | \$5,000    |
| 7-12  | \$10,000   |
| 13-18 | \$15,000   |
| 19-24 | \$20,000   |
| 25-30 | \$25,000   |

